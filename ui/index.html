<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Studio</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>

<body>
    <!-- ‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1>Gemini <span class="accent">Studio</span></h1>
            <p>Create images, voiceovers & scripts with Google's AI</p>
            <button id="googleSignInBtn" class="google-signin-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#EA4335"
                        d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                    <path fill="#4285F4"
                        d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                    <path fill="#FBBC05"
                        d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
                    <path fill="#34A853"
                        d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                </svg>
                Sign in with Google
            </button>
            <p class="login-hint">Only authorized users can access this app</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê API KEY MODAL ‚ïê‚ïê‚ïê -->
    <div id="apiKeyModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <h2>Set Up Your API Key</h2>
            <p>Enter your Google Gemini API key to get started. Each user needs their own key.</p>
            <p class="modal-hint">Get your key from <a href="https://aistudio.google.com/apikey" target="_blank"
                    rel="noopener">Google AI Studio</a></p>
            <input type="password" id="apiKeyInput" class="style-input" placeholder="AIza...">
            <div id="apiKeyError" class="error-message" style="display: none;"></div>
            <button id="saveApiKeyBtn" onclick="saveApiKey()">Save API Key</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê -->
    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div class="header-row">
                <div>
                    <h1>Gemini <span class="accent">Studio</span></h1>
                    <p>Create images, voiceovers & scripts with Google's AI</p>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <span id="userName" class="user-name"></span>
                    <button class="btn-secondary signout-btn" onclick="signOut()">Sign Out</button>
                </div>
            </div>
        </header>

        <!-- Tab Bar -->
        <nav class="tab-bar">
            <button class="tab active" data-tab="image" onclick="switchTab('image')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <path d="m21 15-5-5L5 21" />
                </svg>
                Image
            </button>
            <button class="tab" data-tab="voiceover" onclick="switchTab('voiceover')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                    <line x1="12" x2="12" y1="19" y2="22" />
                </svg>
                Voiceover
            </button>
            <button class="tab" data-tab="visuals" onclick="switchTab('visuals')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
                Visuals
            </button>
            <button class="tab" data-tab="research" onclick="switchTab('research')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
                Research & Script
            </button>
        </nav>

        <!-- ============ IMAGE TAB ============ -->
        <main id="tab-image" class="tab-content active">
            <div class="input-group">
                <textarea id="promptInput"
                    placeholder="Describe the image you want to create... e.g., A cyberpunk city in neon rain"></textarea>
                <div class="controls">
                    <button id="generateBtn" onclick="generateImage()">
                        <span id="btnText">Generate</span>
                        <div class="spinner" id="loadingSpinner"></div>
                    </button>
                </div>
            </div>

            <div class="result-area" id="resultArea">
                <div class="placeholder-text" id="placeholderApp">
                    Your creation will appear here
                </div>
                <img id="generatedImage" src="" alt="Generated Image" style="display: none;">
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </main>

        <!-- ============ VOICEOVER TAB ============ -->
        <main id="tab-voiceover" class="tab-content">
            <div class="input-group">
                <label class="input-label">Style instructions</label>
                <input type="text" id="styleInput" class="style-input"
                    placeholder="Read aloud in a warm and friendly tone">

                <label class="input-label">Text</label>
                <textarea id="ttsTextInput" placeholder="Start writing or paste text here to generate speech..."
                    rows="8"></textarea>

                <div class="controls tts-controls">
                    <div class="voice-selector">
                        <label class="input-label" for="voiceSelect">Voice</label>
                        <select id="voiceSelect">
                            <option value="Zephyr">Zephyr ‚Äî Bright, Higher pitch</option>
                            <option value="Puck">Puck ‚Äî Upbeat, Middle pitch</option>
                            <option value="Charon">Charon ‚Äî Informative, Lower pitch</option>
                            <option value="Kore" selected>Kore ‚Äî Firm, Middle pitch</option>
                            <option value="Fenrir">Fenrir ‚Äî Excitable, Lower middle</option>
                            <option value="Aoede">Aoede ‚Äî Breezy, Higher pitch</option>
                            <option value="Leda">Leda ‚Äî Youthful, Higher pitch</option>
                            <option value="Orus">Orus ‚Äî Firm, Lower pitch</option>
                            <option value="Perseus">Perseus ‚Äî Casual, Lower pitch</option>
                            <option value="Schedar">Schedar ‚Äî Even keeled, Lower pitch</option>
                            <option value="Achernar">Achernar ‚Äî Soft, Higher pitch</option>
                            <option value="Gacrux">Gacrux ‚Äî Mature, Lower pitch</option>
                            <option value="Pulcherrima">Pulcherrima ‚Äî Forward, Higher pitch</option>
                            <option value="Vindemiatrix">Vindemiatrix ‚Äî Gentle, Lower pitch</option>
                            <option value="Sadachbia">Sadachbia ‚Äî Lively, Higher pitch</option>
                            <option value="Sadaltager">Sadaltager ‚Äî Knowledgeable, Lower pitch</option>
                            <option value="Sulafat">Sulafat ‚Äî Warm, Middle pitch</option>
                            <option value="Laomedeia">Laomedeia ‚Äî Upbeat, Higher pitch</option>
                            <option value="Callirrhoe">Callirrhoe ‚Äî Easy-going, Middle pitch</option>
                            <option value="Autonoe">Autonoe ‚Äî Bright, Higher pitch</option>
                            <option value="Enceladus">Enceladus ‚Äî Breathy, Middle pitch</option>
                            <option value="Iapetus">Iapetus ‚Äî Clear, Middle pitch</option>
                            <option value="Umbriel">Umbriel ‚Äî Easy-going, Middle pitch</option>
                            <option value="Algieba">Algieba ‚Äî Smooth, Lower pitch</option>
                            <option value="Despina">Despina ‚Äî Smooth, Higher pitch</option>
                            <option value="Erinome">Erinome ‚Äî Clear, Higher pitch</option>
                            <option value="Algenib">Algenib ‚Äî Gravelly, Lower pitch</option>
                            <option value="Rasalgethi">Rasalgethi ‚Äî Informative, Middle pitch</option>
                            <option value="Hyperion">Hyperion ‚Äî Deliberate, Lower pitch</option>
                            <option value="Mimas">Mimas ‚Äî Flat, Lower pitch</option>
                        </select>
                    </div>
                    <button id="ttsGenerateBtn" onclick="generateTTS()">
                        <span id="ttsBtnText">Generate</span>
                        <div class="spinner" id="ttsLoadingSpinner"></div>
                    </button>
                </div>
            </div>

            <!-- Audio Result -->
            <div class="result-area audio-result-area" id="ttsResultArea">
                <div class="placeholder-text" id="ttsPlaceholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.5">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                        <line x1="12" x2="12" y1="19" y2="22" />
                    </svg>
                    <span>Your voiceover will appear here</span>
                </div>
                <div id="audioPlayerWrap" class="audio-player-wrap" style="display: none;">
                    <audio id="audioPlayer" controls></audio>
                    <a id="downloadBtn" class="download-btn" download="voiceover.wav">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" x2="12" y1="15" y2="3" />
                        </svg>
                        Download WAV
                    </a>
                </div>
            </div>

            <div id="ttsErrorMessage" class="error-message" style="display: none;"></div>
        </main>

        <!-- ============ VISUALS TAB ============ -->
        <main id="tab-visuals" class="tab-content">

            <!-- Data Loading Section -->
            <div class="visuals-data-section">
                <h3 class="section-title">Load Production Data</h3>
                <div class="input-mode-toggle">
                    <button class="mode-btn active" id="visualsModeAuto" onclick="setVisualsDataMode('auto')">
                        Auto-detect from Phase 3
                    </button>
                    <button class="mode-btn" id="visualsModeManual" onclick="setVisualsDataMode('manual')">
                        Paste Production JSON
                    </button>
                </div>
                <div id="visualsAutoLoad">
                    <div class="source-badge" id="visualsLoadStatus">
                        <span class="source-dot idle"></span>
                        No production data loaded yet
                    </div>
                    <button class="btn-secondary" onclick="loadLatestProductionTable()" id="loadProdTableBtn">
                        Load Latest Production Table
                    </button>
                </div>
                <div id="visualsManualLoad" style="display: none;">
                    <textarea id="visualsPasteArea" class="paste-area" rows="6"
                        placeholder='Paste production table JSON here... (the full JSON from Phase 3)'></textarea>
                    <button class="btn-secondary" style="margin-top: 8px;" onclick="importVisualsJson()">
                        Import JSON
                    </button>
                </div>
            </div>

            <!-- Visual Style Configuration -->
            <div class="visuals-config-section" id="visualsConfigSection" style="display: none;">
                <h3 class="section-title">Visual Style Configuration</h3>
                <div class="param-row">
                    <div class="param-field">
                        <label class="input-label" for="visAspectRatio">Aspect Ratio</label>
                        <select id="visAspectRatio" onchange="updateVisualsConfig()">
                            <option value="16:9" selected>16:9 Landscape</option>
                            <option value="9:16">9:16 Portrait</option>
                            <option value="1:1">1:1 Square</option>
                            <option value="3:4">3:4</option>
                            <option value="4:3">4:3</option>
                            <option value="4:5">4:5</option>
                            <option value="5:4">5:4</option>
                        </select>
                    </div>
                    <div class="param-field">
                        <label class="input-label" for="visResolution">Resolution</label>
                        <select id="visResolution" onchange="updateVisualsConfig()">
                            <option value="1K">1K (Fast)</option>
                            <option value="2K" selected>2K (Balanced)</option>
                            <option value="4K">4K (High Quality)</option>
                        </select>
                    </div>
                    <div class="param-field">
                        <label class="input-label" for="visImageModel">Image Model</label>
                        <select id="visImageModel" onchange="updateVisualsConfig()">
                            <option value="gemini-3-pro-image-preview" selected>Gemini 3 Pro (Quality)</option>
                            <option value="gemini-2.5-flash-image">Gemini Flash (Fast)</option>
                        </select>
                    </div>
                    <div class="param-field">
                        <label class="input-label" for="visVeoModel">Veo Model</label>
                        <select id="visVeoModel" onchange="updateVisualsConfig()">
                            <option value="veo-3.1-generate-preview" selected>Veo 3.1 (Quality + Audio)</option>
                            <option value="veo-3.1-fast">Veo 3.1 Fast</option>
                        </select>
                    </div>
                </div>

                <!-- Style Reference Images -->
                <div class="visuals-style-images">
                    <label class="input-label">Style Reference Images (1-4)</label>
                    <p class="paste-hint">Upload images that define the visual style. These will be sent as references with every image generation.</p>
                    <div class="image-upload-area">
                        <input type="file" id="visStyleImageInput" accept="image/*" multiple style="display: none;"
                            onchange="handleVisualsStyleUpload(event)">
                        <button class="btn-secondary" onclick="document.getElementById('visStyleImageInput').click()">
                            Upload Style Images (Max 4)
                        </button>
                        <button class="btn-secondary" onclick="clearVisualsStyleImages()" id="visClearStyleBtn" style="display: none;">
                            Clear
                        </button>
                    </div>
                    <div id="visStyleImagePreviews" class="image-previews"></div>
                </div>

                <!-- Additional Context -->
                <div style="margin-top: 12px;">
                    <label class="input-label" for="visAdditionalContext">Additional Context</label>
                    <input type="text" id="visAdditionalContext" class="style-input"
                        placeholder="e.g., 2D Cartoon Style, Anime, Photorealistic..." onchange="updateVisualsConfig()">
                </div>
            </div>

            <!-- Character Management -->
            <div class="visuals-characters-section" id="visualsCharactersSection" style="display: none;">
                <h3 class="section-title">Characters</h3>
                <p class="paste-hint">Define characters with reference images for consistent appearance across scenes.</p>
                <div id="characterList" class="character-list"></div>
                <button class="btn-secondary" onclick="openAddCharacterModal()">+ Add Character</button>
            </div>

            <!-- Character Modal -->
            <div id="characterModal" class="modal-overlay" style="display: none;">
                <div class="modal-card">
                    <h2>Add Character</h2>
                    <label class="input-label">Character Name</label>
                    <input type="text" id="charNameInput" class="style-input" placeholder="e.g., Detective Miller">
                    <label class="input-label" style="margin-top: 12px;">Reference Images (1-4)</label>
                    <div class="image-upload-area">
                        <input type="file" id="charImageInput" accept="image/*" multiple style="display: none;"
                            onchange="handleCharImageUpload(event)">
                        <button class="btn-secondary" onclick="document.getElementById('charImageInput').click()">
                            Upload Images
                        </button>
                    </div>
                    <div id="charImagePreviews" class="image-previews" style="margin-top: 8px;"></div>
                    <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                        <button class="btn-secondary" onclick="closeCharacterModal()">Cancel</button>
                        <button onclick="saveCharacter()">Save Character</button>
                    </div>
                </div>
            </div>

            <!-- Scene List -->
            <div id="visualsSceneList" class="visuals-scene-list" style="display: none;"></div>

            <!-- Global Action Bar -->
            <div class="visuals-action-bar" id="visualsActionBar" style="display: none;">
                <div class="visuals-action-info">
                    <span id="visualsSceneCount">0 scenes</span>
                    <span id="visualsImageProgress" style="display: none;"></span>
                    <span id="visualsVideoProgress" style="display: none;"></span>
                </div>
                <div class="visuals-action-buttons">
                    <button id="generateAllImagesBtn" onclick="generateAllImages()">
                        Generate All Images
                    </button>
                    <button id="animateAllBtn" onclick="animateAllScenes()" style="display: none;">
                        Animate All Marked
                    </button>
                    <button class="btn-secondary" onclick="downloadAllAssets()">
                        Download All Assets
                    </button>
                </div>
            </div>

            <div id="visualsError" class="error-message" style="display: none;"></div>
        </main>

        <!-- ============ RESEARCH & SCRIPT TAB ============ -->
        <main id="tab-research" class="tab-content">

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 PHASE 1: RESEARCH
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="phase-card" id="phase1Card">
                <div class="phase-header">
                    <div class="phase-number">1</div>
                    <div class="phase-title-group">
                        <h3 class="phase-title">üìö Research</h3>
                        <p class="phase-subtitle">Gather facts, sources, and context on any topic</p>
                    </div>
                    <div class="phase-status" id="phase1Status">Not started</div>
                </div>

                <div class="phase-body" id="phase1Body">
                    <!-- Template Selection -->
                    <div id="templateSection">
                        <label class="input-label">Choose a Template</label>
                        <div class="template-grid" id="templateGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Research Parameters (shown after template selection) -->
                    <div id="researchParams" style="display: none;">
                        <div class="selected-template-badge" id="selectedBadge"></div>

                        <label class="input-label">Topic / Idea</label>
                        <textarea id="researchTopic" rows="3"
                            placeholder="e.g., How the fast fashion industry exploits workers in developing countries"></textarea>

                        <div class="param-row">
                            <div class="param-field" style="flex: 1;">
                                <label class="input-label" for="researchModelSelect">Research Depth</label>
                                <select id="researchModelSelect">
                                    <option value="fast">‚ö° Fast (Gemini Flash)</option>
                                    <option value="deep" selected>üß† Deep (Gemini Pro + Search)</option>
                                    <option value="deep_research_agent">üî¨ Deep Research Agent (2-5 min)</option>
                                </select>
                            </div>
                        </div>

                        <div class="controls">
                            <button class="btn-secondary" onclick="resetTemplate()">‚Üê Back</button>
                            <button id="researchBtn" onclick="startResearch()">
                                <span id="researchBtnText">üîç Start Research</span>
                                <div class="spinner" id="researchSpinner"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Research Results (shown after research completes) -->
                    <div id="researchResults" style="display: none;">
                        <div class="section-header" onclick="toggleCollapse('researchBody')">
                            <label class="input-label">üìÑ Research Dossier</label>
                            <span class="collapse-icon" id="researchBody-icon">‚ñº</span>
                        </div>
                        <div id="researchBody" class="collapsible">
                            <div class="research-summary" id="researchSummary"></div>
                            <div class="key-facts" id="keyFacts"></div>
                            <div class="sources-list" id="sourcesList"></div>
                        </div>
                    </div>

                </div>

                <div id="phase1Error" class="error-message" style="display: none;"></div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 PHASE 2: NARRATION
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="phase-card" id="phase2Card">
                <div class="phase-header">
                    <div class="phase-number">2</div>
                    <div class="phase-title-group">
                        <h3 class="phase-title">‚úçÔ∏è Narration</h3>
                        <p class="phase-subtitle">Choose audience, angle & tone, then generate your narration</p>
                    </div>
                    <div class="phase-status" id="phase2Status">Waiting for input</div>
                </div>

                <div class="phase-body" id="phase2Body">
                    <!-- Input Mode Toggle -->
                    <div class="input-mode-toggle">
                        <button class="mode-btn active" id="scriptModeAuto" onclick="setScriptInputMode('auto')">
                            üîó Use Research from Phase 1
                        </button>
                        <button class="mode-btn" id="scriptModeManual" onclick="setScriptInputMode('manual')">
                            üìã Paste Your Own Script
                        </button>
                    </div>

                    <!-- Auto mode: multi-step wizard -->
                    <div id="scriptAutoInput">
                        <div class="source-badge" id="scriptSourceBadge">
                            <span class="source-dot idle"></span>
                            No research loaded yet ‚Äî complete Phase 1 or switch to manual mode
                        </div>

                        <!-- STEP A: Audience -->
                        <div id="wizardStepA" class="wizard-step" style="display: none;">
                            <label class="input-label">Step 1: Who is your audience?</label>
                            <div class="param-row" style="align-items: flex-end;">
                                <div class="param-field" style="flex: 1;">
                                    <select id="audienceSelect">
                                        <option value="General" selected>General</option>
                                        <option value="Young Adults (18-25)">Young Adults (18-25)</option>
                                        <option value="Professionals">Professionals</option>
                                        <option value="Expert">Expert</option>
                                    </select>
                                </div>
                                <button class="btn-secondary" onclick="confirmAudience()">Next ‚Üí</button>
                            </div>
                        </div>

                        <!-- STEP B: Title / Narrative Angle -->
                        <div id="wizardStepB" class="wizard-step" style="display: none;">
                            <label class="input-label">Step 2: Choose a narrative angle</label>
                            <p class="paste-hint">Each title represents a different way to tell the story. Pick one, edit it, or write your own.</p>
                            <div id="titleSpinnerWrap" style="display: none;">
                                <div class="title-loading">
                                    <div class="spinner" style="display: inline-block;"></div>
                                    <span>Generating title suggestions...</span>
                                </div>
                            </div>
                            <div id="titleCards" class="title-cards-grid"></div>
                            <div id="titleEditSection" style="display: none;">
                                <label class="input-label" style="margin-top: 12px;">Your Title</label>
                                <input type="text" id="titleEditInput" class="style-input title-edit-input"
                                    placeholder="Type your own title or edit the selected one">
                                <div style="margin-top: 8px;">
                                    <button class="btn-secondary" onclick="confirmTitle()">Confirm Title ‚Üí</button>
                                </div>
                                <div id="titleConfirmedBadge" class="source-badge" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- STEP C: Length, Tone, Focus -->
                        <div id="wizardStepC" class="wizard-step" style="display: none;">
                            <label class="input-label">Step 3: Script parameters</label>
                            <div class="param-row">
                                <div class="param-field">
                                    <label class="input-label" for="durationSelect">Video Length</label>
                                    <select id="durationSelect">
                                        <option value="5">5 minutes</option>
                                        <option value="10" selected>10 minutes</option>
                                        <option value="15">15 minutes</option>
                                        <option value="20">20 minutes</option>
                                    </select>
                                </div>
                                <div class="param-field">
                                    <label class="input-label" for="toneSelect">Tone</label>
                                    <select id="toneSelect">
                                        <option value="">Auto (from template)</option>
                                        <option value="Investigative">Investigative</option>
                                        <option value="Conversational">Conversational</option>
                                        <option value="Confrontational">Confrontational</option>
                                        <option value="Neutral">Neutral</option>
                                        <option value="Educational">Educational</option>
                                        <option value="Entertaining">Entertaining</option>
                                    </select>
                                    <div id="toneSuggestionBadge" class="tone-suggestion" style="display: none;"></div>
                                </div>
                            </div>
                            <label class="input-label">Focus angle <span style="color:#555">(optional)</span></label>
                            <input type="text" id="focusInput" class="style-input"
                                placeholder="e.g., Focus on the environmental impact specifically">

                            <!-- Script Style Selection -->
                            <div style="margin-top: 12px;">
                                <label class="input-label">Script Style</label>
                                <div class="style-toggle">
                                    <label>
                                        <input type="radio" name="styleMode" value="template" checked
                                            onclick="toggleStyleInput()">
                                        <span>Use Template Default</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="styleMode" value="transcript"
                                            onclick="toggleStyleInput()">
                                        <span>Analyze Transcript Style</span>
                                    </label>
                                </div>
                                <div id="transcriptStyleInput" style="display: none; margin-top: 10px;">
                                    <textarea id="styleTranscript" class="style-input" rows="6"
                                        placeholder="Paste the beginning of a transcript here (first 5-10 minutes)...
We'll analyze the pacing, tone, and structure to write YOUR script in this style."></textarea>
                                </div>
                            </div>

                            <div class="controls" style="margin-top: 12px;">
                                <button id="scriptBtn" onclick="generateNarration()">
                                    <span id="scriptBtnText">‚úçÔ∏è Generate Narration</span>
                                    <div class="spinner" id="scriptSpinner"></div>
                                </button>
                            </div>
                        </div>

                        <!-- STEP D: Narration Display -->
                        <div id="wizardStepD" class="wizard-step" style="display: none;">
                            <label class="input-label">Your Narration <span id="narrationEditHint" style="font-weight:400; color:#888; font-size:0.8rem;">(click any beat text to edit inline)</span></label>
                            <div id="narrationDisplay" class="narration-display"></div>
                            <div class="controls script-actions">
                                <button class="btn-secondary" onclick="copyNarration()">üìã Copy</button>
                                <button class="btn-secondary" onclick="downloadNarration()">üíæ Download</button>
                                <button id="lockNarrationBtn" class="btn-primary" onclick="lockNarration()">üîí Lock Narration & Continue to Phase 3</button>
                            </div>
                        </div>
                    </div>

                    <!-- Manual mode: paste plain text or JSON -->
                    <div id="scriptManualInput" style="display: none;">
                        <label class="input-label">Paste Your Script</label>
                        <p class="paste-hint">
                            ‚úÖ <strong>Paste your plain text script</strong> ‚Äî the system will automatically break it
                            down into scenes<br>
                            <small style="color: #666;">Or paste structured JSON:
                                <code>{ "script": [ { "scene": 1, ... } ] }</code></small>
                        </p>
                        <textarea id="scriptPasteArea" rows="8" class="paste-area" placeholder="Paste your script here as plain text...

The system will automatically:
‚Ä¢ Break it down into timed scenes
‚Ä¢ Extract visual descriptions
‚Ä¢ Prepare it for production (Phase 3)

No formatting needed ‚Äî just paste your narration!"></textarea>

                        <!-- Manual Style Input -->
                        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                            <label class="input-label" style="display:flex; align-items:center; cursor:pointer;"
                                onclick="toggleManualStyle()">
                                <span>üé® Apply Style from Transcript (Optional)</span>
                                <span id="manualStyleToggleArrow"
                                    style="margin-left:auto; transform: rotate(-90deg); transition: transform 0.2s;">‚ñº</span>
                            </label>
                            <div id="manualStyleSection" style="display:none; margin-top: 8px;">
                                <textarea id="manualStyleTranscript" class="style-input" rows="4"
                                    placeholder="Paste a reference transcript here (first 5-10 mins). We'll analyze its pacing and Visual Style to break down YOUR script."></textarea>
                            </div>
                        </div>
                        <div class="controls" style="margin-top: 12px;">
                            <button onclick="importScript()">
                                <span>üìã Import & Breakdown Script</span>
                            </button>
                        </div>
                    </div>

                    <!-- Script Results -->
                    <div id="scriptResults" style="display: none;">
                        <div class="script-header">
                            <h3 id="scriptTitle" class="script-title"></h3>
                            <div class="script-meta" id="scriptMeta"></div>
                        </div>
                        <div class="script-table-wrap">
                            <table class="script-table" id="scriptTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Time</th>
                                        <th>Act / Beat</th>
                                        <th>Narration</th>
                                        <th>Visual</th>
                                        <th>Emotion</th>
                                    </tr>
                                </thead>
                                <tbody id="scriptTableBody"></tbody>
                            </table>
                        </div>
                        <div class="controls script-actions">
                            <button class="btn-secondary" onclick="copyScript()">üìã Copy Script</button>
                            <button class="btn-secondary" onclick="downloadScript()">üíæ Download JSON</button>
                        </div>
                    </div>
                </div>

                <div id="phase2Error" class="error-message" style="display: none;"></div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 PHASE 3: PRODUCTION TABLE
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="phase-card" id="phase3Card">
                <div class="phase-header">
                    <div class="phase-number">3</div>
                    <div class="phase-title-group">
                        <h3 class="phase-title">üé¨ Production Table</h3>
                        <p class="phase-subtitle">Generate AI-ready video prompts for every shot (Veo 3.1)</p>
                    </div>
                    <div class="phase-status" id="phase3Status">Waiting for input</div>
                </div>

                <div class="phase-body" id="phase3Body">
                    <!-- Input Mode Toggle -->
                    <div class="input-mode-toggle">
                        <button class="mode-btn active" id="prodModeAuto" onclick="setProdInputMode('auto')">
                            üîó Use Script from Phase 2
                        </button>
                        <button class="mode-btn" id="prodModeManual" onclick="setProdInputMode('manual')">
                            üìã Paste Your Own Narration JSON
                        </button>
                    </div>

                    <!-- Auto mode: uses script data -->
                    <div id="prodAutoInput">
                        <div class="source-badge" id="prodSourceBadge">
                            <span class="source-dot idle"></span>
                            No narration loaded yet ‚Äî complete Phase 2 or switch to manual mode
                        </div>
                    </div>

                    <!-- Manual mode: paste JSON -->
                    <div id="prodManualInput" style="display: none;">
                        <label class="input-label">Paste Narration JSON</label>
                        <p class="paste-hint">Paste a JSON object with a <code>"narration"</code> array of acts/beats.
                            Legacy <code>"script"</code> arrays are also accepted and will be converted.</p>
                        <textarea id="prodPasteArea" rows="8" class="paste-area"
                            placeholder='{ "title": "My Video", "narration": [ { "act": "ACT 1", "beat": "Hook", "text": "..." } ] }'></textarea>
                        <div class="controls" style="margin-top: 12px;">
                            <button onclick="importSceneBreakdown()">
                                <span>üìã Import Narration</span>
                            </button>
                        </div>
                    </div>

                    <!-- Style Reference Images -->
                    <div class="style-images-section" id="styleImagesSection">
                        <label class="input-label">Style Reference Images (Optional)</label>
                        <p class="paste-hint">
                            Upload 1-4 images to define a <strong>custom visual style</strong>. The AI will extract
                            the <em>artistic intent</em> and recommend which prompt fields to use.
                        </p>
                        <div class="image-upload-area">
                            <input type="file" id="styleImageInput" accept="image/*" multiple style="display: none;"
                                onchange="handleStyleImageUpload(event)">
                            <button class="btn-secondary" onclick="document.getElementById('styleImageInput').click()">
                                Upload Images (Max 4)
                            </button>
                            <button class="btn-secondary" onclick="clearStyleImages()" id="clearImagesBtn"
                                style="display: none;">
                                Clear Images
                            </button>
                        </div>
                        <div id="styleImagePreviews" class="image-previews"></div>
                        <div id="styleAnalysisResult" class="style-analysis-result" style="display: none;"></div>
                    </div>

                    <!-- Free-Text Style Input (alternative to images) -->
                    <div class="style-text-section" id="styleTextSection">
                        <label class="input-label">Or Describe Your Visual Style</label>
                        <p class="paste-hint">
                            No reference images? Describe the look you want in plain language.
                        </p>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <textarea id="styleTextInput" class="text-area" rows="2"
                                placeholder="e.g., 2D cartoon with bold outlines, bright primary colors, simple backgrounds, no shadows"
                                style="flex: 1;"></textarea>
                            <button class="btn-secondary" onclick="analyzeStyleFromText()" id="analyzeTextBtn">
                                Analyze
                            </button>
                        </div>
                    </div>

                    <!-- Style Review & Approval Panel -->
                    <div id="styleReviewPanel" class="style-review-panel" style="display: none;">
                        <div class="review-header">
                            <label class="input-label">Style Review & Approval</label>
                            <span id="styleApprovedBadge" class="style-approved-badge" style="display: none;">Approved</span>
                        </div>

                        <div class="review-field">
                            <label>Style Summary</label>
                            <textarea id="reviewStyleSummary" rows="2" class="review-input"></textarea>
                        </div>

                        <div class="review-grid">
                            <div class="review-field">
                                <label>Detail Level</label>
                                <input type="text" id="reviewDetailLevel" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Scene Complexity</label>
                                <input type="text" id="reviewSceneComplexity" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Camera Language</label>
                                <input type="text" id="reviewCameraLanguage" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Lighting Approach</label>
                                <input type="text" id="reviewLighting" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Subject Framing</label>
                                <input type="text" id="reviewSubjectFraming" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Writing Style</label>
                                <input type="text" id="reviewWritingStyle" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Color Palette</label>
                                <input type="text" id="reviewColorPalette" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Texture</label>
                                <input type="text" id="reviewTexture" class="review-input">
                            </div>
                            <div class="review-field">
                                <label>Default Mood</label>
                                <input type="text" id="reviewMoodDefault" class="review-input">
                            </div>
                        </div>

                        <div class="review-field" style="margin-top: 12px;">
                            <label>Prompt Schema ‚Äî Which fields to include in production prompts</label>
                            <div id="schemaFieldsChecklist" class="schema-checklist"></div>
                        </div>

                        <div class="review-field" style="margin-top: 12px;">
                            <label>Aspect Ratio</label>
                            <select id="reviewAspectRatio" class="review-input" style="width: auto;">
                                <option value="16:9" selected>16:9 Landscape</option>
                                <option value="9:16">9:16 Portrait</option>
                            </select>
                        </div>

                        <div class="controls" style="margin-top: 12px;">
                            <button class="btn-primary" onclick="approveStyle()">
                                Approve Style & Schema
                            </button>
                            <button class="btn-secondary" onclick="clearApprovedStyle()">
                                Reset
                            </button>
                        </div>
                    </div>

                    <div class="controls" style="margin-top: 16px;">
                        <button id="productionBtn" onclick="generateProductionTable()">
                            <span id="productionBtnText">Generate Production Table</span>
                            <div class="spinner" id="productionSpinner"></div>
                        </button>
                    </div>

                    <!-- Production Table Results -->
                    <div id="productionResults" style="display: none;">
                        <div class="production-header">
                            <h3 class="script-title">Production Shots</h3>
                            <div class="script-meta" id="productionMeta"></div>
                        </div>
                        <div class="production-table-wrap">
                            <table class="production-table" id="productionTable">
                                <thead>
                                    <tr>
                                        <th>Shot</th>
                                        <th>Script / Beat</th>
                                        <th>Dur</th>
                                        <th>Director's Intent</th>
                                        <th>First Frame Prompt</th>
                                        <th>Last Frame Prompt</th>
                                        <th>Veo 3.1 Prompt</th>
                                    </tr>
                                </thead>
                                <tbody id="productionTableBody"></tbody>
                            </table>
                        </div>

                        <!-- Continuity Notes -->
                        <div id="continuityNotes" style="display:none; margin-top:16px;">
                            <div class="section-header" onclick="toggleCollapse('continuityBody')">
                                <label class="input-label">üîó Continuity Notes</label>
                                <span class="collapse-icon" id="continuityBody-icon">‚ñº</span>
                            </div>
                            <div id="continuityBody" class="collapsible">
                                <div id="continuityContent"></div>
                            </div>
                        </div>

                        <div class="controls script-actions">
                            <button class="btn-secondary" onclick="copyFirstFramePrompts()">üñºÔ∏è Copy All First Frame
                                Prompts</button>
                            <button class="btn-secondary" onclick="copyLastFramePrompts()">üñºÔ∏è Copy All Last Frame
                                Prompts</button>
                            <button class="btn-secondary" onclick="copyVeoPrompts()">üé¨ Copy All Veo Prompts</button>
                            <button class="btn-secondary" onclick="copyAllPrompts()">üìã Copy All Prompts</button>
                            <button class="btn-secondary" onclick="downloadProductionTable()">üíæ Download JSON</button>
                        </div>
                    </div>
                </div>

                <div id="phase3Error" class="error-message" style="display: none;"></div>
            </div>

        </main>
    </div>

    <script>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FIREBASE AUTH
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        const firebaseConfig = {
            apiKey: "AIzaSyCjxbYKvgw66YAC-RzfylEmJC2cFnqW8b0",
            authDomain: "gen-lang-client-0854991687.firebaseapp.com",
            projectId: "gen-lang-client-0854991687",
            storageBucket: "gen-lang-client-0854991687.firebasestorage.app",
            messagingSenderId: "637532740810",
            appId: "1:637532740810:web:c31e25a6f9c3f5a5a6a833"
        };

        firebase.initializeApp(firebaseConfig);
        const authInstance = firebase.auth();
        let currentUser = null;
        let idToken = null;

        // Authenticated fetch wrapper ‚Äî adds Authorization header to all API calls
        async function authFetch(url, options = {}) {
            if (!idToken) throw new Error('Not authenticated');
            const headers = { ...(options.headers || {}), 'Authorization': `Bearer ${idToken}` };
            return fetch(url, { ...options, headers });
        }

        // Auth state listener
        authInstance.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                idToken = await user.getIdToken();

                // Refresh token periodically (tokens expire after 1 hour)
                setInterval(async () => {
                    idToken = await user.getIdToken(true);
                }, 50 * 60 * 1000); // Refresh every 50 minutes

                // Show user info
                document.getElementById('userAvatar').src = user.photoURL || '';
                document.getElementById('userName').textContent = user.displayName || user.email;
                document.getElementById('userInfo').style.display = 'flex';

                // Check if user has API key
                try {
                    const res = await authFetch('/api/check-api-key');
                    const data = await res.json();
                    if (data.has_key) {
                        showApp();
                    } else {
                        showApiKeyModal();
                    }
                } catch (e) {
                    showApiKeyModal();
                }
            } else {
                currentUser = null;
                idToken = null;
                showLogin();
            }
        });

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            authInstance.signInWithPopup(provider).catch((error) => {
                console.error('Sign-in error:', error);
                alert('Sign-in failed: ' + error.message);
            });
        }

        function signOut() {
            authInstance.signOut();
        }

        async function saveApiKey() {
            const keyInput = document.getElementById('apiKeyInput');
            const errorDiv = document.getElementById('apiKeyError');
            const key = keyInput.value.trim();

            errorDiv.style.display = 'none';

            if (!key || !key.startsWith('AIza') || key.length < 35) {
                errorDiv.textContent = 'Invalid API key format. It should start with "AIza" and be at least 35 characters.';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const res = await authFetch('/api/save-api-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: key }),
                });
                const data = await res.json();

                if (res.ok) {
                    showApp();
                } else {
                    throw new Error(data.error || 'Failed to save API key');
                }
            } catch (e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('apiKeyModal').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApiKeyModal() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('apiKeyModal').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('apiKeyModal').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           GLOBAL STATE
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let selectedTemplate = null;
        let currentDossier = '';
        let selectedTitle = null;
        let currentScriptData = null;
        let currentNarration = null;   // Narration data (acts/beats) from Phase 2
        let currentDossierId = null;   // Firestore dossier ID
        let currentProductionData = null;
        let styleReferenceImages = []; // Array of base64 image data
        let approvedStyle = null; // Structured style dict {style_summary, style_intent, prompt_schema}

        // Master list of all possible prompt fields
        const PROMPT_FIELDS = [
            { key: 'shot_size', label: 'Shot Size (wide, medium, close-up)', locked: true },
            { key: 'subject', label: 'Subject Description', locked: true },
            { key: 'arrangement', label: 'Pose / Camera Angle', locked: true },
            { key: 'background', label: 'Background / Environment', locked: true },
            { key: 'mood', label: 'Mood / Atmosphere', locked: false },
            { key: 'lighting', label: 'Lighting Setup', locked: false },
            { key: 'lighting_direction', label: 'Lighting Direction & Color Temp', locked: false },
            { key: 'camera_lens', label: 'Camera Lens (mm)', locked: false },
            { key: 'camera_aperture', label: 'Aperture / f-stop', locked: false },
            { key: 'dof', label: 'Depth of Field', locked: false },
            { key: 'film_stock', label: 'Film Stock / Texture', locked: false },
            { key: 'color_restriction', label: 'Color Palette', locked: false },
            { key: 'output_style', label: 'Output Style / Aesthetic', locked: false },
            { key: 'room_objects', label: 'Props / Objects', locked: false },
            { key: 'made_out_of', label: 'Material / Texture', locked: false },
            { key: 'tags', label: 'Aesthetic Tags', locked: false },
        ];
        let deepResearchInteractionId = null; // Interaction ID for async deep research
        let deepResearchPollTimer = null; // Polling timer for deep research

        /* ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ */
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load templates when switching to research tab
            if (tabName === 'research' && !document.getElementById('templateGrid').children.length) {
                loadTemplates();
            }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           IMAGE GENERATION
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        async function generateImage() {
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('loadingSpinner');
            const img = document.getElementById('generatedImage');
            const placeholder = document.getElementById('placeholderApp');
            const errorDiv = document.getElementById('errorMessage');

            if (!prompt) return;

            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';
            img.style.display = 'none';
            placeholder.style.display = 'block';
            placeholder.innerText = "Dreaming...";

            try {
                const response = await authFetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt }),
                });
                const data = await response.json();

                if (response.ok) {
                    img.src = data.image_url;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                } else {
                    throw new Error(data.error || 'Failed to generate image');
                }
            } catch (error) {
                console.error('Error:', error);
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
                placeholder.innerText = "Error occurred";
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TTS GENERATION
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        async function generateTTS() {
            const text = document.getElementById('ttsTextInput').value;
            const voice = document.getElementById('voiceSelect').value;
            const style = document.getElementById('styleInput').value;
            const btn = document.getElementById('ttsGenerateBtn');
            const btnText = document.getElementById('ttsBtnText');
            const spinner = document.getElementById('ttsLoadingSpinner');
            const placeholder = document.getElementById('ttsPlaceholder');
            const playerWrap = document.getElementById('audioPlayerWrap');
            const audioPlayer = document.getElementById('audioPlayer');
            const downloadBtn = document.getElementById('downloadBtn');
            const errorDiv = document.getElementById('ttsErrorMessage');

            if (!text.trim()) return;

            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';
            playerWrap.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.querySelector('span').textContent = "Generating voiceover...";

            try {
                const response = await authFetch('/api/generate-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voice, style_instructions: style }),
                });
                const data = await response.json();

                if (response.ok) {
                    audioPlayer.src = data.audio_url;
                    downloadBtn.href = data.audio_url;
                    playerWrap.style.display = 'flex';
                    placeholder.style.display = 'none';
                    audioPlayer.play();
                } else {
                    throw new Error(data.error || 'Failed to generate TTS');
                }
            } catch (error) {
                console.error('Error:', error);
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
                placeholder.querySelector('span').textContent = "Error occurred";
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           RESEARCH & SCRIPT WRITING (3-Phase)
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* ‚îÄ‚îÄ Phase Status Helper ‚îÄ‚îÄ */
        function updatePhaseStatus(phaseNum, status, type) {
            // type: 'idle' | 'running' | 'complete' | 'error'
            const el = document.getElementById(`phase${phaseNum}Status`);
            el.textContent = status;
            el.className = 'phase-status';
            if (type) el.classList.add(`status-${type}`);
        }

        /* ‚îÄ‚îÄ Input Mode Toggles ‚îÄ‚îÄ */
        function setScriptInputMode(mode) {
            const autoBtn = document.getElementById('scriptModeAuto');
            const manualBtn = document.getElementById('scriptModeManual');
            const autoInput = document.getElementById('scriptAutoInput');
            const manualInput = document.getElementById('scriptManualInput');

            if (mode === 'auto') {
                autoBtn.classList.add('active');
                manualBtn.classList.remove('active');
                autoInput.style.display = 'block';
                manualInput.style.display = 'none';
            } else {
                autoBtn.classList.remove('active');
                manualBtn.classList.add('active');
                autoInput.style.display = 'none';
                manualInput.style.display = 'block';
            }
        }

        function setProdInputMode(mode) {
            const autoBtn = document.getElementById('prodModeAuto');
            const manualBtn = document.getElementById('prodModeManual');
            const autoInput = document.getElementById('prodAutoInput');
            const manualInput = document.getElementById('prodManualInput');

            if (mode === 'auto') {
                autoBtn.classList.add('active');
                manualBtn.classList.remove('active');
                autoInput.style.display = 'block';
                manualInput.style.display = 'none';
            } else {
                autoBtn.classList.remove('active');
                manualBtn.classList.add('active');
                autoInput.style.display = 'none';
                manualInput.style.display = 'block';
            }
        }

        /* ‚îÄ‚îÄ Source Badge Updates ‚îÄ‚îÄ */
        function updateScriptSourceBadge() {
            const badge = document.getElementById('scriptSourceBadge');
            if (currentDossier) {
                badge.innerHTML = '<span class="source-dot ready"></span> Research loaded ‚Äî select your audience to begin';
                document.getElementById('wizardStepA').style.display = 'block';
            } else {
                badge.innerHTML = '<span class="source-dot idle"></span> No research loaded yet ‚Äî complete Phase 1 or switch to manual mode';
                document.getElementById('wizardStepA').style.display = 'none';
            }
        }

        function updateProdSourceBadge() {
            const badge = document.getElementById('prodSourceBadge');
            if (currentNarration) {
                const beats = currentNarration.narration || [];
                let actCount = 0;
                let beatCount = 0;
                if (Array.isArray(beats)) {
                    actCount = new Set(beats.map(b => b.act)).size;
                    beatCount = beats.length;
                }
                badge.innerHTML = `<span class="source-dot ready"></span> Narration loaded (${actCount} acts, ${beatCount} beats) ‚Äî ready to generate production table`;
            } else {
                badge.innerHTML = '<span class="source-dot idle"></span> No narration loaded yet ‚Äî complete Phase 2 or switch to manual mode';
            }
        }

        /* ‚îÄ‚îÄ Templates ‚îÄ‚îÄ */
        async function loadTemplates() {
            const grid = document.getElementById('templateGrid');
            try {
                const response = await authFetch('/api/templates');
                const data = await response.json();
                grid.innerHTML = data.templates.map(t => `
                    <button class="template-card" onclick="selectTemplate('${t.id}', this)" data-id="${t.id}">
                        <span class="template-icon">${t.icon}</span>
                        <span class="template-name">${t.name}</span>
                        <span class="template-desc">${t.description}</span>
                        <span class="template-examples">${t.example_topics.map(e => `<em>${e}</em>`).join(' ¬∑ ')}</span>
                    </button>
                `).join('');
            } catch (e) {
                grid.innerHTML = '<p style="color:#ff6b6b">Failed to load templates. Is the server running?</p>';
            }
        }

        function selectTemplate(templateId, el) {
            selectedTemplate = templateId;
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            const badge = document.getElementById('selectedBadge');
            badge.textContent = `${el.querySelector('.template-icon').textContent} ${el.querySelector('.template-name').textContent}`;
            document.getElementById('researchParams').style.display = 'flex';
            document.getElementById('templateSection').style.display = 'none';
        }

        function resetTemplate() {
            selectedTemplate = null;
            document.getElementById('templateSection').style.display = 'flex';
            document.getElementById('researchParams').style.display = 'none';
            document.getElementById('researchResults').style.display = 'none';
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
        }

        /* ‚îÄ‚îÄ Phase 1: Research ‚îÄ‚îÄ */
        async function startResearch() {
            const topic = document.getElementById('researchTopic').value.trim();
            if (!topic) return alert('Please enter a topic.');
            if (!selectedTemplate) return alert('Please select a template first.');

            const btn = document.getElementById('researchBtn');
            const btnText = document.getElementById('researchBtnText');
            const spinner = document.getElementById('researchSpinner');
            const errorDiv = document.getElementById('phase1Error');
            const researchModel = document.getElementById('researchModelSelect').value;

            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';
            document.getElementById('researchResults').style.display = 'none';

            // Clear any previous deep research polling
            if (deepResearchPollTimer) {
                clearInterval(deepResearchPollTimer);
                deepResearchPollTimer = null;
            }

            updatePhaseStatus(1, researchModel === 'deep_research_agent' ? 'Starting Deep Research Agent‚Ä¶' : 'Researching‚Ä¶', 'running');

            try {
                const response = await authFetch('/api/research', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        template_id: selectedTemplate,
                        research_model: researchModel
                    }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Research failed');

                // Async deep research: start polling
                if (data.async && data.interaction_id) {
                    deepResearchInteractionId = data.interaction_id;
                    updatePhaseStatus(1, 'Deep Research running‚Ä¶ (polling every 10s)', 'running');
                    btnText.textContent = 'üî¨ Researching‚Ä¶';
                    btnText.style.display = 'inline';
                    spinner.style.display = 'inline-block';

                    deepResearchPollTimer = setInterval(() => {
                        pollDeepResearch(topic);
                    }, 10000);
                    return; // Don't reset button ‚Äî polling continues
                }

                // Synchronous result (fast/deep)
                displayResearchResults(data);

            } catch (error) {
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
                updatePhaseStatus(1, 'Error', 'error');
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnText.textContent = 'üîç Start Research';
                spinner.style.display = 'none';
            }
        }

        async function pollDeepResearch(topic) {
            const errorDiv = document.getElementById('phase1Error');
            try {
                const response = await authFetch('/api/research/poll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interaction_id: deepResearchInteractionId,
                        topic: topic,
                        template_id: selectedTemplate,
                    }),
                });

                const data = await response.json();

                if (data.status === 'in_progress') {
                    return; // Keep polling
                }

                // Stop polling
                clearInterval(deepResearchPollTimer);
                deepResearchPollTimer = null;
                deepResearchInteractionId = null;

                const btn = document.getElementById('researchBtn');
                const btnText = document.getElementById('researchBtnText');
                const spinner = document.getElementById('researchSpinner');
                btn.disabled = false;
                btnText.textContent = 'üîç Start Research';
                btnText.style.display = 'inline';
                spinner.style.display = 'none';

                if (data.error || data.status === 'failed') {
                    throw new Error(data.error || 'Deep research failed');
                }

                // Completed
                displayResearchResults(data);

            } catch (error) {
                clearInterval(deepResearchPollTimer);
                deepResearchPollTimer = null;
                deepResearchInteractionId = null;

                const btn = document.getElementById('researchBtn');
                const btnText = document.getElementById('researchBtnText');
                const spinner = document.getElementById('researchSpinner');
                btn.disabled = false;
                btnText.textContent = 'üîç Start Research';
                btnText.style.display = 'inline';
                spinner.style.display = 'none';

                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
                updatePhaseStatus(1, 'Error', 'error');
            }
        }

        function displayResearchResults(data) {
            currentDossier = data.dossier;

            // Display results
            document.getElementById('researchSummary').innerHTML =
                `<h4>Summary</h4><p>${escapeHtml(data.summary)}</p>`;

            if (data.key_facts && data.key_facts.length) {
                document.getElementById('keyFacts').innerHTML =
                    `<h4>Key Facts</h4><ul>${data.key_facts.map(f => `<li>${escapeHtml(f)}</li>`).join('')}</ul>`;
            } else {
                document.getElementById('keyFacts').innerHTML = '';
            }

            if (data.sources && data.sources.length) {
                document.getElementById('sourcesList').innerHTML =
                    `<h4>Sources Referenced</h4><ul class="sources">${data.sources.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul>`;
            } else {
                document.getElementById('sourcesList').innerHTML = '';
            }

            document.getElementById('researchResults').style.display = 'block';

            const factCount = data.key_facts?.length || 0;
            const model = document.getElementById('researchModelSelect').value;
            const label = model === 'deep_research_agent' ? 'Deep Research complete' : `Research complete (${factCount} facts)`;
            updatePhaseStatus(1, label, 'complete');

            // Reset button state
            const btn = document.getElementById('researchBtn');
            const btnText = document.getElementById('researchBtnText');
            const spinner = document.getElementById('researchSpinner');
            btn.disabled = false;
            btnText.textContent = 'üîç Start Research';
            btnText.style.display = 'inline';
            spinner.style.display = 'none';

            // Auto-update downstream Phase 2 source badge (shows wizardStepA)
            updateScriptSourceBadge();
        }

        /* ‚îÄ‚îÄ Title Suggestions (Phase 2 Wizard) ‚îÄ‚îÄ */
        async function suggestTitles() {
            const spinnerWrap = document.getElementById('titleSpinnerWrap');
            const cardsDiv = document.getElementById('titleCards');
            const editSection = document.getElementById('titleEditSection');

            spinnerWrap.style.display = 'flex';
            cardsDiv.innerHTML = '';
            editSection.style.display = 'none';
            selectedTitle = null;

            try {
                const response = await authFetch('/api/suggest-titles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: document.getElementById('researchTopic').value.trim(),
                        template_id: selectedTemplate,
                        dossier: currentDossier,
                        audience: document.getElementById('audienceSelect').value,
                    }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Title suggestion failed');

                spinnerWrap.style.display = 'none';

                cardsDiv.innerHTML = data.titles.map((t, i) => `
                    <button class="title-card" onclick="selectTitleCard(${i}, this)" data-title="${escapeHtml(t.title)}">
                        <span class="title-card-number">${i + 1}</span>
                        <span class="title-card-text">${escapeHtml(t.title)}</span>
                        <span class="title-card-desc">${escapeHtml(t.description)}</span>
                    </button>
                `).join('');

                editSection.style.display = 'block';

                document.getElementById('titleEditInput').addEventListener('input', function () {
                    selectedTitle = this.value.trim();
                    updateTitleConfirmBadge();
                });

            } catch (error) {
                spinnerWrap.style.display = 'none';
                cardsDiv.innerHTML = `<p style="color:#ff6b6b">Failed to generate titles: ${escapeHtml(error.message)}</p>`;
                editSection.style.display = 'block';
            }
        }

        function selectTitleCard(index, el) {
            document.querySelectorAll('.title-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            const title = el.getAttribute('data-title');
            document.getElementById('titleEditInput').value = title;
            selectedTitle = title;
            updateTitleConfirmBadge();
        }

        function updateTitleConfirmBadge() {
            const badge = document.getElementById('titleConfirmedBadge');
            if (selectedTitle) {
                badge.style.display = 'block';
                badge.innerHTML = `<span class="source-dot ready"></span> Title: "${escapeHtml(selectedTitle)}"`;
            } else {
                badge.style.display = 'none';
            }
        }

        /* ‚îÄ‚îÄ Phase 2: Narration Wizard ‚îÄ‚îÄ */
        function toggleStyleInput() {
            const isTranscript = document.querySelector('input[name="styleMode"][value="transcript"]').checked;
            document.getElementById('transcriptStyleInput').style.display = isTranscript ? 'block' : 'none';
        }

        function confirmAudience() {
            document.getElementById('wizardStepB').style.display = 'block';
            suggestTitles();
        }

        function confirmTitle() {
            const titleInput = document.getElementById('titleEditInput').value.trim();
            if (!titleInput) {
                selectedTitle = null;
                return alert('Please select or type a title first.');
            }
            selectedTitle = titleInput;
            updateTitleConfirmBadge();
            autoSuggestTone();
        }

        async function autoSuggestTone() {
            const badge = document.getElementById('toneSuggestionBadge');
            badge.style.display = 'block';
            badge.innerHTML = 'Suggesting tone...';

            try {
                const response = await authFetch('/api/auto-suggest-tone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_id: selectedTemplate,
                        selected_title: selectedTitle,
                        audience: document.getElementById('audienceSelect').value,
                    }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Tone suggestion failed');

                const toneSelect = document.getElementById('toneSelect');
                const suggestedTone = data.suggested_tone || 'Conversational';
                const options = Array.from(toneSelect.options);
                const match = options.find(o => o.value.toLowerCase() === suggestedTone.toLowerCase());
                if (match) {
                    toneSelect.value = match.value;
                } else {
                    toneSelect.value = '';
                }

                badge.innerHTML = `Suggested: <strong>${escapeHtml(suggestedTone)}</strong> ‚Äî ${escapeHtml(data.reasoning || '')}`;

            } catch (error) {
                badge.innerHTML = `<span style="color:#888">Could not auto-suggest tone</span>`;
                console.error('Tone suggestion error:', error);
            }

            document.getElementById('wizardStepC').style.display = 'block';
        }

        async function generateNarration() {
            if (!currentDossier) return alert('No research data. Run research first, or switch to manual mode.');

            const topic = document.getElementById('researchTopic').value.trim();
            const btn = document.getElementById('scriptBtn');
            const btnText = document.getElementById('scriptBtnText');
            const spinner = document.getElementById('scriptSpinner');
            const errorDiv = document.getElementById('phase2Error');

            const styleMode = document.querySelector('input[name="styleMode"]:checked').value;
            const styleTranscript = document.getElementById('styleTranscript').value.trim();

            if (styleMode === 'transcript' && !styleTranscript) {
                return alert('Please paste a transcript to analyze.');
            }

            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';

            updatePhaseStatus(2, 'Writing narration‚Ä¶', 'running');

            try {
                const response = await authFetch('/api/generate-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        template_id: selectedTemplate,
                        dossier: currentDossier,
                        duration_minutes: document.getElementById('durationSelect').value,
                        audience: document.getElementById('audienceSelect').value,
                        tone: document.getElementById('toneSelect').value,
                        focus: document.getElementById('focusInput').value,
                        style_mode: styleMode,
                        style_transcript: styleTranscript,
                        selected_title: selectedTitle || ''
                    }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Narration generation failed');

                currentNarration = data.narration;
                renderNarration(data.narration);
                document.getElementById('wizardStepD').style.display = 'block';

                const beats = data.narration?.narration || [];
                let actCount = 0;
                let beatCount = 0;
                if (Array.isArray(beats)) {
                    actCount = new Set(beats.map(b => b.act)).size;
                    beatCount = beats.length;
                }
                updatePhaseStatus(2, `Narration complete (${actCount} acts, ${beatCount} beats)`, 'complete');
                updateProdSourceBadge();

            } catch (error) {
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
                updatePhaseStatus(2, 'Error', 'error');
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function renderNarration(narrationObj) {
            const container = document.getElementById('narrationDisplay');
            const beats = Array.isArray(narrationObj) ? narrationObj : (narrationObj?.narration || []);

            if (!beats.length) {
                if (narrationObj?.raw_text) {
                    container.innerHTML = `<div class="narration-beat"><div class="narration-beat-text">${escapeHtml(narrationObj.raw_text)}</div></div>`;
                } else {
                    container.innerHTML = '<p style="color:#888">No narration data to display.</p>';
                }
                return;
            }

            let headerHtml = '';
            if (narrationObj?.title) {
                const totalWords = beats.reduce((sum, b) => sum + (b.text || b.narration || '').split(/\s+/).length, 0);
                headerHtml = `<div style="margin-bottom: 12px;">
                    <h3 class="script-title">${escapeHtml(narrationObj.title)}</h3>
                    <div class="script-meta">
                        ${narrationObj.hook_type ? `<span class="meta-tag">Hook: ${escapeHtml(narrationObj.hook_type)}</span>` : ''}
                        ${narrationObj.duration_minutes ? `<span class="meta-tag">${narrationObj.duration_minutes} min</span>` : ''}
                        <span class="meta-tag">${beats.length} beats</span>
                        <span class="meta-tag">~${totalWords} words</span>
                    </div>
                </div>`;
            }

            const acts = {};
            beats.forEach((beat, idx) => {
                const actName = beat.act || 'Unknown';
                if (!acts[actName]) acts[actName] = [];
                acts[actName].push({ ...beat, _index: idx });
            });

            let html = headerHtml;
            for (const [actName, actBeats] of Object.entries(acts)) {
                const safeAct = escapeHtml(actName);
                html += `<div class="narration-act" data-act="${safeAct}">`;
                html += `<div class="narration-act-header">
                    <span>${safeAct}</span>
                    <div class="act-controls">
                        <button class="btn-tiny btn-restyle" onclick="regenerateAct('${safeAct}', 'restyle')" title="Restyle this act">Restyle Act</button>
                        <button class="btn-tiny btn-reimagine" onclick="regenerateAct('${safeAct}', 'reimagine')" title="Reimagine this act with different facts">Reimagine Act</button>
                    </div>
                </div>`;
                for (const beat of actBeats) {
                    const beatText = beat.text || beat.narration || '';
                    html += `<div class="narration-beat" data-beat-index="${beat._index}">`;
                    html += `<div class="narration-beat-header">`;
                    html += `<div class="narration-beat-label">${escapeHtml(beat.beat || '')}</div>`;
                    html += `<div class="beat-controls">
                        <button class="btn-tiny btn-restyle" onclick="regenerateBeat(${beat._index}, 'restyle')" title="Restyle">Restyle</button>
                        <button class="btn-tiny btn-reimagine" onclick="regenerateBeat(${beat._index}, 'reimagine')" title="Reimagine">Reimagine</button>
                    </div>`;
                    html += `</div>`;
                    html += `<div class="narration-beat-text" contenteditable="true" data-beat-index="${beat._index}" onblur="onBeatTextEdit(this, ${beat._index})">${escapeHtml(beatText)}</div>`;
                    html += `</div>`;
                }
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        function onBeatTextEdit(el, beatIndex) {
            if (!currentNarration || !currentNarration.narration) return;
            const newText = el.innerText.trim();
            if (currentNarration.narration[beatIndex]) {
                currentNarration.narration[beatIndex].text = newText;
            }
        }

        async function regenerateBeat(beatIndex, mode) {
            if (!currentNarration) return;
            const beatEl = document.querySelector(`.narration-beat[data-beat-index="${beatIndex}"]`);
            if (beatEl) beatEl.classList.add('regenerating');

            try {
                const resp = await fetch('/api/regenerate-beat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await firebase.auth().currentUser.getIdToken()}` },
                    body: JSON.stringify({
                        topic: document.getElementById('topicInput')?.value || '',
                        template_id: selectedTemplate || 'educational_explainer',
                        dossier: currentDossier || '',
                        narration: currentNarration,
                        target_beat_indices: [beatIndex],
                        mode: mode,
                        audience: document.getElementById('audienceSelect')?.value || 'General',
                        tone: document.getElementById('toneSelect')?.value || '',
                        duration_minutes: parseInt(document.getElementById('durationSelect')?.value) || 10,
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                if (data.beats && data.beats.length > 0) {
                    const regen = data.beats[0];
                    currentNarration.narration[beatIndex] = {
                        ...currentNarration.narration[beatIndex],
                        text: regen.text || regen.narration || '',
                        beat: regen.beat || currentNarration.narration[beatIndex].beat,
                    };
                    renderNarration(currentNarration);
                }
            } catch (err) {
                alert(`Regeneration failed: ${err.message}`);
            } finally {
                if (beatEl) beatEl.classList.remove('regenerating');
            }
        }

        async function regenerateAct(actName, mode) {
            if (!currentNarration) return;
            const actEl = document.querySelector(`.narration-act[data-act="${actName}"]`);
            if (actEl) actEl.classList.add('regenerating');

            try {
                const resp = await fetch('/api/regenerate-beat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await firebase.auth().currentUser.getIdToken()}` },
                    body: JSON.stringify({
                        topic: document.getElementById('topicInput')?.value || '',
                        template_id: selectedTemplate || 'educational_explainer',
                        dossier: currentDossier || '',
                        narration: currentNarration,
                        target_act: actName,
                        mode: mode,
                        audience: document.getElementById('audienceSelect')?.value || 'General',
                        tone: document.getElementById('toneSelect')?.value || '',
                        duration_minutes: parseInt(document.getElementById('durationSelect')?.value) || 10,
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                if (data.beats && data.beats.length > 0) {
                    let targetIndices = [];
                    currentNarration.narration.forEach((b, i) => {
                        if (b.act === actName) targetIndices.push(i);
                    });
                    data.beats.forEach((regen, j) => {
                        if (j < targetIndices.length) {
                            const idx = targetIndices[j];
                            currentNarration.narration[idx] = {
                                ...currentNarration.narration[idx],
                                text: regen.text || regen.narration || '',
                                beat: regen.beat || currentNarration.narration[idx].beat,
                            };
                        }
                    });
                    renderNarration(currentNarration);
                }
            } catch (err) {
                alert(`Act regeneration failed: ${err.message}`);
            } finally {
                if (actEl) actEl.classList.remove('regenerating');
            }
        }

        function lockNarration() {
            if (!currentNarration) return alert('No narration to lock.');
            // Sync any contenteditable changes
            document.querySelectorAll('.narration-beat-text[contenteditable]').forEach(el => {
                const idx = parseInt(el.dataset.beatIndex);
                if (!isNaN(idx) && currentNarration.narration[idx]) {
                    currentNarration.narration[idx].text = el.innerText.trim();
                }
            });
            // Disable editing
            document.querySelectorAll('.narration-beat-text[contenteditable]').forEach(el => {
                el.contentEditable = 'false';
            });
            document.querySelectorAll('.beat-controls, .act-controls').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById('lockNarrationBtn').disabled = true;
            document.getElementById('lockNarrationBtn').textContent = 'üîí Narration Locked';
            document.getElementById('narrationEditHint').textContent = '(locked)';
            // Switch to Phase 3
            switchTab('production');
            updateProdSourceBadge();
        }

        function copyNarration() {
            if (!currentNarration) return;
            const beats = currentNarration.narration || [];
            if (!Array.isArray(beats) || beats.length === 0) {
                if (currentNarration.raw_text) {
                    navigator.clipboard.writeText(currentNarration.raw_text);
                    alert('Narration copied to clipboard!');
                }
                return;
            }
            const text = beats.map(b =>
                `[${b.act || ''}] ${b.beat || ''}\n${b.text || b.narration || ''}`
            ).join('\n\n');
            navigator.clipboard.writeText(text);
            alert('Narration copied to clipboard!');
        }

        function downloadNarration() {
            if (!currentNarration) return;
            const blob = new Blob([JSON.stringify({ narration: currentNarration }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `narration_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleManualStyle() {
            const section = document.getElementById('manualStyleSection');
            const arrow = document.getElementById('manualStyleToggleArrow');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                section.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        function importScript() {
            const textarea = document.getElementById('scriptPasteArea');
            const errorDiv = document.getElementById('phase2Error');
            errorDiv.style.display = 'none';
            const rawValue = textarea.value.trim();

            if (!rawValue) return alert("Please paste a script first.");

            try {
                const parsed = JSON.parse(rawValue);

                if (parsed.narration && Array.isArray(parsed.narration)) {
                    // Already in narration format
                    currentNarration = parsed;
                } else if (parsed.script && Array.isArray(parsed.script)) {
                    // Legacy scene breakdown ‚Üí convert to narration format
                    const beats = [];
                    const seenBeats = {};
                    for (const scene of parsed.script) {
                        const actName = scene.act || 'IMPORTED';
                        const beatName = scene.beat || ('Scene ' + (scene.scene || '?'));
                        const key = actName + '|||' + beatName;
                        if (seenBeats[key]) {
                            seenBeats[key].text += ' ' + (scene.narration || '');
                        } else {
                            const beat = { act: actName, beat: beatName, text: scene.narration || '' };
                            seenBeats[key] = beat;
                            beats.push(beat);
                        }
                    }
                    currentNarration = {
                        title: parsed.title || 'Imported Script',
                        duration_minutes: parsed.duration_minutes || 10,
                        narration: beats,
                    };
                } else {
                    throw new Error('JSON must have a "narration" or "script" array.');
                }
            } catch (jsonError) {
                // Plain text ‚Üí wrap as narration
                currentNarration = {
                    title: 'Manual Script',
                    duration_minutes: parseInt(document.getElementById('durationSelect')?.value || '10'),
                    narration: [{ act: 'MANUAL', beat: 'Full Script', text: rawValue }],
                };
            }

            renderNarration(currentNarration);
            document.getElementById('wizardStepD').style.display = 'block';

            const beats = currentNarration.narration || [];
            const actCount = new Set(beats.map(b => b.act)).size;
            updatePhaseStatus(2, `Imported (${actCount} acts, ${beats.length} beats)`, 'complete');
            updateProdSourceBadge();
        }

        function renderScriptTable(script) {
            document.getElementById('scriptTitle').textContent = script.title || 'Imported Script';
            document.getElementById('scriptMeta').innerHTML = [
                script.hook_type ? `<span class="meta-tag">Hook: ${script.hook_type}</span>` : '',
                script.duration_minutes ? `<span class="meta-tag">${script.duration_minutes} min</span>` : '',
                script.total_scenes ? `<span class="meta-tag">${script.total_scenes} scenes</span>` : '',
            ].join('');

            const tbody = document.getElementById('scriptTableBody');
            if (script.script && Array.isArray(script.script)) {
                tbody.innerHTML = script.script.map(row => `
                    <tr>
                        <td class="cell-num">${row.scene || ''}</td>
                        <td class="cell-time">${row.timestamp || ''}</td>
                        <td class="cell-act"><strong>${row.act || ''}</strong><br><em>${row.beat || ''}</em></td>
                        <td class="cell-narration">${escapeHtml(row.narration || '')}</td>
                        <td class="cell-visual">${escapeHtml(row.visual || '')}</td>
                        <td class="cell-emotion"><span class="emotion-tag">${row.emotion || ''}</span></td>
                    </tr>
                `).join('');
            } else if (script.raw_text) {
                tbody.innerHTML = `<tr><td colspan="6" style="white-space:pre-wrap">${escapeHtml(script.raw_text)}</td></tr>`;
            }

            document.getElementById('scriptResults').style.display = 'block';
        }


        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           PHASE 3: PRODUCTION TABLE
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        function importSceneBreakdown() {
            const textarea = document.getElementById('prodPasteArea');
            const errorDiv = document.getElementById('phase3Error');
            errorDiv.style.display = 'none';

            try {
                const parsed = JSON.parse(textarea.value.trim());

                if (parsed.narration && Array.isArray(parsed.narration)) {
                    // Already narration format
                    currentNarration = parsed;
                } else if (parsed.script && Array.isArray(parsed.script)) {
                    // Legacy scene breakdown ‚Üí convert to narration
                    const beats = [];
                    const seenBeats = {};
                    for (const scene of parsed.script) {
                        const actName = scene.act || 'IMPORTED';
                        const beatName = scene.beat || ('Scene ' + (scene.scene || '?'));
                        const key = actName + '|||' + beatName;
                        if (seenBeats[key]) {
                            seenBeats[key].text += ' ' + (scene.narration || '');
                        } else {
                            const beat = { act: actName, beat: beatName, text: scene.narration || '' };
                            seenBeats[key] = beat;
                            beats.push(beat);
                        }
                    }
                    currentNarration = {
                        title: parsed.title || 'Imported Script',
                        duration_minutes: parsed.duration_minutes || 10,
                        narration: beats,
                    };
                } else {
                    throw new Error('JSON must have a "narration" or "script" array.');
                }

                const beatCount = (currentNarration.narration || []).length;
                updatePhaseStatus(3, `‚úÖ Imported ${beatCount} beats ‚Äî ready to generate`, 'complete');
                updateProdSourceBadge();

            } catch (error) {
                errorDiv.innerText = `Import error: ${error.message}`;
                errorDiv.style.display = 'block';
                updatePhaseStatus(3, '‚ùå Import failed', 'error');
            }
        }

        async function generateProductionTable() {
            if (!currentNarration) return alert('No narration data. Generate narration first, or import a script.');

            const btn = document.getElementById('productionBtn');
            const btnText = document.getElementById('productionBtnText');
            const spinner = document.getElementById('productionSpinner');
            const errorDiv = document.getElementById('phase3Error');

            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';
            document.getElementById('productionResults').style.display = 'none';

            updatePhaseStatus(3, 'Generating prompts‚Ä¶', 'running');

            try {
                const requestBody = {
                    narration: currentNarration,
                    duration_minutes: currentNarration.duration_minutes
                        || parseInt(document.getElementById('durationSelect').value) || 10,
                };

                if (approvedStyle) {
                    requestBody.style_analysis = approvedStyle;
                    requestBody.aspect_ratio = document.getElementById('reviewAspectRatio').value;
                    console.log('[Production] Using approved style:', approvedStyle.style_summary);
                } else {
                    requestBody.aspect_ratio = '16:9';
                    console.log('[Production] No style approved ‚Äî using default cinematic style');
                }

                const response = await authFetch('/api/generate-production-table', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Production table generation failed');

                currentProductionData = data;
                renderProductionTable(data.production_table);

                const shotCount = data.production_table?.total_shots || data.production_table?.shots?.length || '?';
                updatePhaseStatus(3, `‚úÖ Complete ‚Äî ${shotCount} shots`, 'complete');

            } catch (error) {
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
                updatePhaseStatus(3, '‚ùå Error', 'error');
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function renderProductionTable(pt) {
            document.getElementById('productionMeta').innerHTML = [
                pt.aspect_ratio ? `<span class="meta-tag">${pt.aspect_ratio}</span>` : '',
                pt.total_shots ? `<span class="meta-tag">${pt.total_shots} shots</span>` : '',
                pt.style_summary ? `<span class="meta-tag" title="${escapeHtml(pt.style_summary)}">${escapeHtml(pt.style_summary.substring(0, 40))}${pt.style_summary.length > 40 ? '‚Ä¶' : ''}</span>` : '',
            ].join('');

            const tbody = document.getElementById('productionTableBody');
            if (pt.shots && Array.isArray(pt.shots)) {
                tbody.innerHTML = pt.shots.map(shot => `
                    <tr>
                        <td class="cell-num">${escapeHtml(shot.shot_number || '')}</td>
                        <td class="cell-beat">
                            ${escapeHtml(shot.script_beat || '')}
                            ${shot.cutting_rationale ? `<div class="cutting-rationale">${escapeHtml(shot.cutting_rationale)}</div>` : ''}
                        </td>
                        <td class="cell-dur">${escapeHtml(shot.duration || '')}</td>
                        <td class="cell-intent">${escapeHtml(shot.directors_intent || '')}</td>
                        <td class="cell-prompt"><pre class="prompt-cell">${escapeHtml(shot.first_frame_prompt || '')}</pre></td>
                        <td class="cell-prompt"><pre class="prompt-cell">${escapeHtml(shot.last_frame_prompt || '')}</pre></td>
                        <td class="cell-prompt"><pre class="prompt-cell">${escapeHtml(shot.veo_prompt || '')}</pre></td>
                    </tr>
                `).join('');
            } else if (pt.raw_text) {
                tbody.innerHTML = `<tr><td colspan="7" style="white-space:pre-wrap">${escapeHtml(pt.raw_text)}</td></tr>`;
            }

            if (pt.continuity_notes && pt.continuity_notes.length > 0) {
                const notesEl = document.getElementById('continuityContent');
                notesEl.innerHTML = pt.continuity_notes.map(n => `
                    <div class="continuity-note">
                        <strong>${escapeHtml(n.from_shot)} ‚Üí ${escapeHtml(n.to_shot)}</strong>
                        <div>Visual: ${escapeHtml(n.visual_bridge || '')}</div>
                        <div>Audio: ${escapeHtml(n.audio_bridge || '')}</div>
                        ${n.potential_issue ? `<div class="note-warning">‚ö†Ô∏è ${escapeHtml(n.potential_issue)}</div>` : ''}
                    </div>
                `).join('');
                document.getElementById('continuityNotes').style.display = 'block';
            }

            document.getElementById('productionResults').style.display = 'block';
        }

        function copyFirstFramePrompts() {
            if (!currentProductionData?.production_table?.shots) return;
            const prompts = currentProductionData.production_table.shots.map((s, idx) =>
                `=== SHOT ${s.shot_number} - FIRST FRAME ===\n${s.first_frame_prompt}`
            );
            navigator.clipboard.writeText(prompts.join('\n\n' + '='.repeat(50) + '\n\n'));
            alert(`‚úÖ Copied ${prompts.length} First Frame Prompts to clipboard!`);
        }

        function copyLastFramePrompts() {
            if (!currentProductionData?.production_table?.shots) return;
            const prompts = currentProductionData.production_table.shots.map((s, idx) =>
                `=== SHOT ${s.shot_number} - LAST FRAME ===\n${s.last_frame_prompt}`
            );
            navigator.clipboard.writeText(prompts.join('\n\n' + '='.repeat(50) + '\n\n'));
            alert(`‚úÖ Copied ${prompts.length} Last Frame Prompts to clipboard!`);
        }

        function copyVeoPrompts() {
            if (!currentProductionData?.production_table?.shots) return;
            const prompts = currentProductionData.production_table.shots.map((s, idx) =>
                `=== SHOT ${s.shot_number} (${s.duration}) - VEO 3.1 ===\n${s.veo_prompt}`
            );
            navigator.clipboard.writeText(prompts.join('\n\n' + '='.repeat(50) + '\n\n'));
            alert(`‚úÖ Copied ${prompts.length} Veo 3.1 Prompts to clipboard!`);
        }

        function copyAllPrompts() {
            if (!currentProductionData?.production_table?.shots) return;
            const lines = currentProductionData.production_table.shots.map(s =>
                `=== SHOT ${s.shot_number} (${s.duration}) ===\n` +
                `SCRIPT: ${s.script_beat}\n\n` +
                `FIRST FRAME:\n${s.first_frame_prompt}\n\n` +
                `LAST FRAME:\n${s.last_frame_prompt}\n\n` +
                `VEO 3.1:\n${s.veo_prompt}\n`
            );
            navigator.clipboard.writeText(lines.join('\n\n'));
            alert('‚úÖ All prompts copied to clipboard!');
        }

        function downloadProductionTable() {
            if (!currentProductionData) return;
            const blob = new Blob([JSON.stringify(currentProductionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `production_table_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           STYLE REFERENCE IMAGES
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        async function handleStyleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            // Limit to 4 images
            const maxImages = 4;
            const remainingSlots = maxImages - styleReferenceImages.length;
            const filesToProcess = files.slice(0, remainingSlots);

            if (files.length > remainingSlots) {
                alert(`Maximum 4 images allowed. Adding first ${remainingSlots} images.`);
            }

            // Convert images to base64
            for (const file of filesToProcess) {
                if (!file.type.startsWith('image/')) continue;

                const reader = new FileReader();
                reader.onload = (e) => {
                    styleReferenceImages.push({
                        name: file.name,
                        data: e.target.result
                    });
                    renderStyleImagePreviews();

                    // Auto-analyze when all images are loaded
                    if (styleReferenceImages.length === filesToProcess.length) {
                        analyzeStyleImages();
                    }
                };
                reader.readAsDataURL(file);
            }

            // Reset input
            event.target.value = '';
        }

        function renderStyleImagePreviews() {
            const container = document.getElementById('styleImagePreviews');
            const clearBtn = document.getElementById('clearImagesBtn');

            if (styleReferenceImages.length === 0) {
                container.innerHTML = '';
                clearBtn.style.display = 'none';
                return;
            }

            clearBtn.style.display = 'inline-block';

            container.innerHTML = styleReferenceImages.map((img, idx) => `
                <div class="image-preview">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="image-preview-remove" onclick="removeStyleImage(${idx})">‚úï</button>
                </div>
            `).join('');
        }

        function removeStyleImage(index) {
            styleReferenceImages.splice(index, 1);
            renderStyleImagePreviews();

            if (styleReferenceImages.length === 0) {
                approvedStyle = null;
                document.getElementById('styleAnalysisResult').style.display = 'none';
                document.getElementById('styleReviewPanel').style.display = 'none';
                document.getElementById('styleTextSection').style.display = 'block';
            } else {
                analyzeStyleImages();
            }
        }

        function clearStyleImages() {
            styleReferenceImages = [];
            approvedStyle = null;
            renderStyleImagePreviews();
            document.getElementById('styleAnalysisResult').style.display = 'none';
            document.getElementById('styleReviewPanel').style.display = 'none';
            document.getElementById('styleTextSection').style.display = 'block';
            document.getElementById('styleApprovedBadge').style.display = 'none';
        }

        async function analyzeStyleImages() {
            if (styleReferenceImages.length === 0) return;

            // Hide text input when images are being analyzed
            document.getElementById('styleTextSection').style.display = 'none';

            const resultDiv = document.getElementById('styleAnalysisResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<h4>Analyzing style...</h4><p>Extracting artistic intent from your images...</p>';

            try {
                const response = await authFetch('/api/analyze-style-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: styleReferenceImages.map(img => img.data)
                    }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Style analysis failed');

                const styleData = data.style_analysis;
                resultDiv.innerHTML = `
                    <h4>Style Extracted</h4>
                    <p><strong>${escapeHtml(styleData.style_summary || 'Custom style')}</strong></p>
                    <small style="color: #888;">Review and approve the style below before generating.</small>
                `;
                showStyleReviewPanel(styleData);

            } catch (error) {
                console.error('Style analysis error:', error);
                resultDiv.innerHTML = `
                    <h4>Analysis Failed</h4>
                    <p style="color: #ff6b6b;">${escapeHtml(error.message)}</p>
                    <small>You can still describe your style in text below.</small>
                `;
                document.getElementById('styleTextSection').style.display = 'block';
            }
        }

        async function analyzeStyleFromText() {
            const description = document.getElementById('styleTextInput').value.trim();
            if (!description) return alert('Please enter a style description.');

            const btn = document.getElementById('analyzeTextBtn');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';

            try {
                const response = await authFetch('/api/analyze-style-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Style analysis failed');

                showStyleReviewPanel(data.style_analysis);

            } catch (error) {
                console.error('Style text analysis error:', error);
                alert('Style analysis failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze';
            }
        }

        function showStyleReviewPanel(styleData) {
            const panel = document.getElementById('styleReviewPanel');
            panel.style.display = 'block';
            document.getElementById('styleApprovedBadge').style.display = 'none';

            const intent = styleData.style_intent || {};
            const schema = styleData.prompt_schema || {};

            // Populate style summary
            document.getElementById('reviewStyleSummary').value = styleData.style_summary || '';

            // Populate style intent fields
            document.getElementById('reviewDetailLevel').value = intent.detail_level || '';
            document.getElementById('reviewSceneComplexity').value = intent.scene_complexity || '';
            document.getElementById('reviewCameraLanguage').value = intent.camera_language || '';
            document.getElementById('reviewLighting').value = intent.lighting_instruction || '';
            document.getElementById('reviewSubjectFraming').value = intent.subject_framing || '';
            document.getElementById('reviewWritingStyle').value = intent.writing_style || '';
            document.getElementById('reviewColorPalette').value = intent.color_palette || '';
            document.getElementById('reviewTexture').value = intent.texture || '';
            document.getElementById('reviewMoodDefault').value = intent.mood_default || '';

            // Build schema checklist
            const alwaysInclude = schema.always_include || ['shot_size', 'subject', 'arrangement', 'background'];
            const include = schema.include || [];
            const exclude = schema.exclude || [];
            const activeFields = new Set([...alwaysInclude, ...include]);

            const checklistEl = document.getElementById('schemaFieldsChecklist');
            checklistEl.innerHTML = PROMPT_FIELDS.map(field => {
                const isLocked = field.locked;
                const isChecked = isLocked || activeFields.has(field.key);
                const isExcluded = exclude.includes(field.key);
                return `
                    <label class="schema-field ${isLocked ? 'schema-field-locked' : ''}">
                        <input type="checkbox" value="${field.key}"
                            ${isChecked && !isExcluded ? 'checked' : ''}
                            ${isLocked ? 'disabled' : ''}>
                        <span>${field.label}</span>
                    </label>
                `;
            }).join('');

            // Scroll to panel
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function approveStyle() {
            // Read all values from the review panel
            const intent = {
                detail_level: document.getElementById('reviewDetailLevel').value,
                scene_complexity: document.getElementById('reviewSceneComplexity').value,
                camera_language: document.getElementById('reviewCameraLanguage').value,
                lighting_instruction: document.getElementById('reviewLighting').value,
                subject_framing: document.getElementById('reviewSubjectFraming').value,
                writing_style: document.getElementById('reviewWritingStyle').value,
                color_palette: document.getElementById('reviewColorPalette').value,
                texture: document.getElementById('reviewTexture').value,
                mood_default: document.getElementById('reviewMoodDefault').value,
            };

            // Read schema from checkboxes
            const alwaysInclude = [];
            const include = [];
            const exclude = [];
            const checkboxes = document.querySelectorAll('#schemaFieldsChecklist input[type="checkbox"]');
            checkboxes.forEach(cb => {
                const field = PROMPT_FIELDS.find(f => f.key === cb.value);
                if (field && field.locked) {
                    alwaysInclude.push(cb.value);
                } else if (cb.checked) {
                    include.push(cb.value);
                } else {
                    exclude.push(cb.value);
                }
            });

            approvedStyle = {
                style_summary: document.getElementById('reviewStyleSummary').value,
                style_intent: intent,
                prompt_schema: {
                    always_include: alwaysInclude,
                    include: include,
                    exclude: exclude,
                },
            };

            document.getElementById('styleApprovedBadge').style.display = 'inline-block';
            console.log('[Style] Approved:', approvedStyle);
        }

        function clearApprovedStyle() {
            approvedStyle = null;
            document.getElementById('styleReviewPanel').style.display = 'none';
            document.getElementById('styleApprovedBadge').style.display = 'none';
            document.getElementById('styleAnalysisResult').style.display = 'none';
            document.getElementById('styleTextSection').style.display = 'block';
        }

        /* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            el.classList.toggle('collapsed');
            icon.textContent = el.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }

        function copyScript() {
            if (!currentScriptData?.script?.script) return;
            const text = currentScriptData.script.script.map(r =>
                `[${r.timestamp}] ${r.narration}`
            ).join('\n\n');
            navigator.clipboard.writeText(text);
            alert('Script copied to clipboard!');
        }

        function downloadScript() {
            if (!currentScriptData) return;
            const blob = new Blob([JSON.stringify(currentScriptData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `script_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function startOver() {
            currentDossier = '';
            selectedTitle = null;
            currentScriptData = null;
            currentNarration = null;
            currentDossierId = null;
            currentProductionData = null;
            approvedStyle = null;

            document.getElementById('researchTopic').value = '';
            document.getElementById('focusInput').value = '';
            document.getElementById('researchResults').style.display = 'none';

            // Reset wizard steps
            document.getElementById('wizardStepA').style.display = 'none';
            document.getElementById('wizardStepB').style.display = 'none';
            document.getElementById('wizardStepC').style.display = 'none';
            document.getElementById('wizardStepD').style.display = 'none';
            document.getElementById('titleCards').innerHTML = '';
            document.getElementById('titleEditInput').value = '';
            document.getElementById('titleConfirmedBadge').style.display = 'none';
            document.getElementById('narrationDisplay').innerHTML = '';
            const toneBadge = document.getElementById('toneSuggestionBadge');
            if (toneBadge) toneBadge.style.display = 'none';

            document.getElementById('scriptResults').style.display = 'none';
            document.getElementById('productionResults').style.display = 'none';
            document.getElementById('continuityNotes').style.display = 'none';
            document.getElementById('scriptPasteArea').value = '';
            document.getElementById('prodPasteArea').value = '';
            resetTemplate();

            // Reset phase statuses
            updatePhaseStatus(1, 'Not started', 'idle');
            updatePhaseStatus(2, 'Waiting for input', 'idle');
            updatePhaseStatus(3, 'Waiting for input', 'idle');

            // Reset source badges
            updateScriptSourceBadge();
            updateProdSourceBadge();

            // Reset input modes to auto
            setScriptInputMode('auto');
            setProdInputMode('auto');

            // Re-bind model select listener
            const modelSelect = document.getElementById('researchModelSelect');
            if (modelSelect) {
                modelSelect.addEventListener('change', function () {
                    const btnText = document.getElementById('researchBtnText');
                    btnText.textContent = this.value === 'deep' ? 'üîç Start Deep Research' : '‚ö° Start Fast Research';
                });
                const btnText = document.getElementById('researchBtnText');
                btnText.textContent = modelSelect.value === 'deep' ? 'üîç Start Deep Research' : '‚ö° Start Fast Research';
            }
        }

        // Run once on load
        document.addEventListener('DOMContentLoaded', () => {
            const modelSelect = document.getElementById('researchModelSelect');
            if (modelSelect) {
                modelSelect.addEventListener('change', function () {
                    const btnText = document.getElementById('researchBtnText');
                    btnText.textContent = this.value === 'deep' ? 'üîç Start Deep Research' : '‚ö° Start Fast Research';
                });
                const btnText = document.getElementById('researchBtnText');
                btnText.textContent = modelSelect.value === 'deep' ? 'üîç Start Deep Research' : '‚ö° Start Fast Research';
            }
        });

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           VISUALS TAB
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        // ‚îÄ‚îÄ Visuals State ‚îÄ‚îÄ
        let visualsProductionData = null;
        let visualsScenes = [];
        let visualsConfig = {
            aspectRatio: '16:9',
            resolution: '2K',
            imageModel: 'gemini-3-pro-image-preview',
            veoModel: 'veo-3.1-generate-preview',
            styleImages: [],
            additionalContext: '',
        };
        let visualsCharacters = [];
        let charModalImages = [];  // temp images for character modal
        let animationPollers = {};
        let visualsGenerationPhase = 'idle'; // 'idle' | 'preview' | 'batch'

        // ‚îÄ‚îÄ Data Loading ‚îÄ‚îÄ
        function setVisualsDataMode(mode) {
            document.getElementById('visualsModeAuto').classList.toggle('active', mode === 'auto');
            document.getElementById('visualsModeManual').classList.toggle('active', mode === 'manual');
            document.getElementById('visualsAutoLoad').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('visualsManualLoad').style.display = mode === 'manual' ? 'block' : 'none';
        }

        async function loadLatestProductionTable() {
            const statusEl = document.getElementById('visualsLoadStatus');
            statusEl.innerHTML = '<span class="source-dot active"></span> Loading...';

            try {
                const res = await authFetch('/api/latest-production-table');
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Failed to load production table');

                const pt = data.production_table;
                initVisualsFromProductionTable(pt);
                statusEl.innerHTML = `<span class="source-dot ready"></span> Loaded: "${pt.title || 'Untitled'}" (${visualsScenes.length} scenes)`;
            } catch (e) {
                statusEl.innerHTML = `<span class="source-dot error"></span> ${e.message}`;
            }
        }

        function importVisualsJson() {
            try {
                const raw = document.getElementById('visualsPasteArea').value.trim();
                if (!raw) { alert('Please paste production table JSON'); return; }

                let data = JSON.parse(raw);
                // Handle both wrapped and unwrapped formats
                const pt = data.production_table || data;

                if (!pt.shots || !Array.isArray(pt.shots)) {
                    throw new Error('Invalid format: expected a "shots" array');
                }

                initVisualsFromProductionTable(pt);
                const statusEl = document.getElementById('visualsLoadStatus');
                statusEl.innerHTML = `<span class="source-dot ready"></span> Imported: "${pt.title || 'Untitled'}" (${visualsScenes.length} scenes)`;
                setVisualsDataMode('auto');
            } catch (e) {
                alert('Error parsing JSON: ' + e.message);
            }
        }

        function initVisualsFromProductionTable(pt) {
            visualsProductionData = pt;
            visualsScenes = (pt.shots || []).map(shot => ({
                sceneId: String(shot.shot_number),
                shotNumber: String(shot.shot_number),
                timestamp: shot.timestamp || '',
                scriptBeat: shot.script_beat || '',
                duration: shot.duration || '',
                directorsIntent: shot.directors_intent || '',
                emotion: shot.emotion || '',
                imagePrompt: shot.first_frame_prompt || '',
                lastFramePrompt: shot.last_frame_prompt || '',
                veoPrompt: shot.veo_prompt || '',
                // Runtime state
                imageStatus: 'idle',
                imageUrl: null,
                imageError: null,
                imageModel: null,
                videoStatus: 'idle',
                videoUrl: null,
                videoError: null,
                veoModel: null,
                operationName: null,
                markedForAnimation: false,
            }));

            visualsGenerationPhase = 'idle';

            // Show config, characters, scene list, and action bar
            document.getElementById('visualsConfigSection').style.display = 'block';
            document.getElementById('visualsCharactersSection').style.display = 'block';
            document.getElementById('visualsSceneList').style.display = 'block';
            document.getElementById('visualsActionBar').style.display = 'flex';
            document.getElementById('visualsSceneCount').textContent = `${visualsScenes.length} scenes`;

            renderVisualsScenes();
        }

        // ‚îÄ‚îÄ Config ‚îÄ‚îÄ
        function updateVisualsConfig() {
            visualsConfig.aspectRatio = document.getElementById('visAspectRatio').value;
            visualsConfig.resolution = document.getElementById('visResolution').value;
            visualsConfig.imageModel = document.getElementById('visImageModel').value;
            visualsConfig.veoModel = document.getElementById('visVeoModel').value;
            visualsConfig.additionalContext = document.getElementById('visAdditionalContext').value;
        }

        // ‚îÄ‚îÄ Style Image Upload ‚îÄ‚îÄ
        function handleVisualsStyleUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            const remaining = 4 - visualsConfig.styleImages.length;
            const toProcess = files.slice(0, remaining);
            if (files.length > remaining) alert(`Max 4 style images. Adding first ${remaining}.`);

            for (const file of toProcess) {
                if (!file.type.startsWith('image/')) continue;
                const reader = new FileReader();
                reader.onload = (e) => {
                    visualsConfig.styleImages.push({ name: file.name, data: e.target.result });
                    renderVisualsStylePreviews();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function renderVisualsStylePreviews() {
            const container = document.getElementById('visStyleImagePreviews');
            const clearBtn = document.getElementById('visClearStyleBtn');
            if (!visualsConfig.styleImages.length) {
                container.innerHTML = '';
                clearBtn.style.display = 'none';
                return;
            }
            clearBtn.style.display = 'inline-block';
            container.innerHTML = visualsConfig.styleImages.map((img, i) => `
                <div class="image-preview">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="image-preview-remove" onclick="removeVisualsStyleImage(${i})">&#x2715;</button>
                </div>
            `).join('');
        }

        function removeVisualsStyleImage(idx) {
            visualsConfig.styleImages.splice(idx, 1);
            renderVisualsStylePreviews();
        }

        function clearVisualsStyleImages() {
            visualsConfig.styleImages = [];
            renderVisualsStylePreviews();
        }

        // ‚îÄ‚îÄ Character Management ‚îÄ‚îÄ
        function openAddCharacterModal() {
            charModalImages = [];
            document.getElementById('charNameInput').value = '';
            document.getElementById('charImagePreviews').innerHTML = '';
            document.getElementById('characterModal').style.display = 'flex';
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').style.display = 'none';
            charModalImages = [];
        }

        function handleCharImageUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            const remaining = 4 - charModalImages.length;
            const toProcess = files.slice(0, remaining);
            if (files.length > remaining) alert(`Max 4 images per character. Adding first ${remaining}.`);

            for (const file of toProcess) {
                if (!file.type.startsWith('image/')) continue;
                const reader = new FileReader();
                reader.onload = (e) => {
                    charModalImages.push({ name: file.name, data: e.target.result });
                    renderCharModalPreviews();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function renderCharModalPreviews() {
            const container = document.getElementById('charImagePreviews');
            container.innerHTML = charModalImages.map((img, i) => `
                <div class="image-preview">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="image-preview-remove" onclick="removeCharModalImage(${i})">&#x2715;</button>
                </div>
            `).join('');
        }

        function removeCharModalImage(idx) {
            charModalImages.splice(idx, 1);
            renderCharModalPreviews();
        }

        function saveCharacter() {
            const name = document.getElementById('charNameInput').value.trim();
            if (!name) { alert('Character name is required'); return; }
            if (!charModalImages.length) { alert('At least one reference image is required'); return; }

            visualsCharacters.push({ name, images: [...charModalImages] });
            closeCharacterModal();
            renderCharacterList();
        }

        function removeCharacter(idx) {
            visualsCharacters.splice(idx, 1);
            renderCharacterList();
        }

        function renderCharacterList() {
            const container = document.getElementById('characterList');
            if (!visualsCharacters.length) {
                container.innerHTML = '<p class="paste-hint">No characters defined yet.</p>';
                return;
            }
            container.innerHTML = visualsCharacters.map((ch, i) => `
                <div class="character-card">
                    <div class="character-card-images">
                        ${ch.images.map(img => `<img src="${img.data}" alt="${ch.name}">`).join('')}
                    </div>
                    <div class="character-card-info">
                        <strong>${escapeHtml(ch.name)}</strong>
                        <span>${ch.images.length} reference image${ch.images.length > 1 ? 's' : ''}</span>
                    </div>
                    <button class="btn-secondary btn-small" onclick="removeCharacter(${i})">Remove</button>
                </div>
            `).join('');
        }

        // Collect all character images as flat array of base64 data URIs
        function getAllCharacterImages() {
            const all = [];
            for (const ch of visualsCharacters) {
                for (const img of ch.images) {
                    if (all.length < 10) all.push(img.data);
                }
            }
            return all;
        }

        // ‚îÄ‚îÄ Scene Card Rendering ‚îÄ‚îÄ
        function renderVisualsScenes() {
            const container = document.getElementById('visualsSceneList');
            container.innerHTML = visualsScenes.map((s, idx) => {
                const imgModelOptions = `
                    <option value="" ${!s.imageModel ? 'selected' : ''}>Global</option>
                    <option value="gemini-3-pro-image-preview" ${s.imageModel === 'gemini-3-pro-image-preview' ? 'selected' : ''}>Pro (Quality)</option>
                    <option value="gemini-2.5-flash-image" ${s.imageModel === 'gemini-2.5-flash-image' ? 'selected' : ''}>Flash (Fast)</option>
                `;
                const veoModelOptions = `
                    <option value="" ${!s.veoModel ? 'selected' : ''}>Global</option>
                    <option value="veo-3.1-generate-preview" ${s.veoModel === 'veo-3.1-generate-preview' ? 'selected' : ''}>Veo 3.1 (Quality)</option>
                    <option value="veo-3.1-fast" ${s.veoModel === 'veo-3.1-fast' ? 'selected' : ''}>Veo Fast</option>
                `;

                return `
                <div class="scene-card" id="scene-card-${idx}" data-scene-idx="${idx}">
                    <div class="scene-card-header">
                        <span class="scene-number">Scene ${s.shotNumber}</span>
                        <span class="scene-timestamp">${escapeHtml(s.timestamp)}</span>
                        <span class="scene-duration">${escapeHtml(s.duration)}</span>
                    </div>
                    <div class="scene-card-narration">
                        <p>"${escapeHtml(s.scriptBeat)}"</p>
                    </div>
                    <div class="scene-card-body">
                        <div class="scene-image-section">
                            <div class="scene-section-header">
                                <label class="input-label">Image Prompt</label>
                                <select class="scene-model-select" onchange="visualsScenes[${idx}].imageModel = this.value || null">
                                    ${imgModelOptions}
                                </select>
                            </div>
                            <textarea class="scene-prompt-textarea" id="scene-img-prompt-${idx}"
                                onchange="visualsScenes[${idx}].imagePrompt = this.value">${escapeHtml(s.imagePrompt)}</textarea>
                            <div class="scene-image-result" id="scene-img-result-${idx}">
                                ${s.imageUrl
                                    ? `<img src="${s.imageUrl}" alt="Scene ${s.shotNumber}"><div class="scene-image-actions">
                                        <button class="btn-small btn-secondary" onclick="regenerateSceneImage(${idx})">Regenerate</button>
                                        <a class="btn-small btn-secondary" href="${s.imageUrl}" download>Download</a>
                                       </div>`
                                    : `<div class="scene-placeholder">Image will appear here</div>`
                                }
                            </div>
                        </div>
                        <div class="scene-video-section">
                            <div class="scene-section-header">
                                <label class="input-label">Animation Prompt (Veo 3.1)</label>
                                <select class="scene-model-select" onchange="visualsScenes[${idx}].veoModel = this.value || null">
                                    ${veoModelOptions}
                                </select>
                            </div>
                            <textarea class="scene-prompt-textarea" id="scene-veo-prompt-${idx}"
                                onchange="visualsScenes[${idx}].veoPrompt = this.value">${escapeHtml(s.veoPrompt)}</textarea>
                            <div class="scene-video-result" id="scene-vid-result-${idx}">
                                ${s.videoUrl
                                    ? `<video src="${s.videoUrl}" controls></video><div class="scene-image-actions">
                                        <a class="btn-small btn-secondary" href="${s.videoUrl}" download>Download</a>
                                       </div>`
                                    : `<div class="scene-placeholder">Video will appear here</div>`
                                }
                            </div>
                            <div class="scene-animation-controls">
                                <label class="scene-animate-toggle">
                                    <input type="checkbox" ${s.markedForAnimation ? 'checked' : ''}
                                        onchange="visualsScenes[${idx}].markedForAnimation = this.checked; updateAnimateAllBtn()">
                                    Animate this scene
                                </label>
                                <button class="btn-small" onclick="animateScene(${idx})" ${!s.imageUrl ? 'disabled title="Generate image first"' : ''}>
                                    Animate Image
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="scene-status-bar" id="scene-status-${idx}">
                        ${getStatusHtml(s)}
                    </div>
                </div>`;
            }).join('');

            updateAnimateAllBtn();
        }

        function getStatusHtml(scene) {
            const imgStatus = scene.imageStatus;
            const vidStatus = scene.videoStatus;

            if (imgStatus === 'generating') return '<span class="status-generating">Generating image...</span>';
            if (vidStatus === 'generating' || vidStatus === 'polling') return '<span class="status-generating">Animating...</span>';
            if (imgStatus === 'error') return `<span class="status-error">Image error: ${escapeHtml(scene.imageError || 'Unknown')}</span>`;
            if (vidStatus === 'error') return `<span class="status-error">Animation error: ${escapeHtml(scene.videoError || 'Unknown')}</span>`;
            if (vidStatus === 'complete') return '<span class="status-complete">Image + Video ready</span>';
            if (imgStatus === 'complete') return '<span class="status-complete">Image ready</span>';
            return '<span class="status-idle">Pending</span>';
        }

        function updateSceneCard(idx) {
            const s = visualsScenes[idx];
            // Update image result
            const imgContainer = document.getElementById(`scene-img-result-${idx}`);
            if (imgContainer) {
                if (s.imageUrl) {
                    imgContainer.innerHTML = `
                        <img src="${s.imageUrl}" alt="Scene ${s.shotNumber}">
                        <div class="scene-image-actions">
                            <button class="btn-small btn-secondary" onclick="regenerateSceneImage(${idx})">Regenerate</button>
                            <a class="btn-small btn-secondary" href="${s.imageUrl}" download>Download</a>
                        </div>`;
                } else if (s.imageStatus === 'generating') {
                    imgContainer.innerHTML = '<div class="scene-placeholder generating">Generating...</div>';
                }
            }
            // Update video result
            const vidContainer = document.getElementById(`scene-vid-result-${idx}`);
            if (vidContainer) {
                if (s.videoUrl) {
                    vidContainer.innerHTML = `
                        <video src="${s.videoUrl}" controls></video>
                        <div class="scene-image-actions">
                            <a class="btn-small btn-secondary" href="${s.videoUrl}" download>Download</a>
                        </div>`;
                } else if (s.videoStatus === 'generating' || s.videoStatus === 'polling') {
                    vidContainer.innerHTML = '<div class="scene-placeholder generating">Animating...</div>';
                }
            }
            // Update status bar
            const statusBar = document.getElementById(`scene-status-${idx}`);
            if (statusBar) statusBar.innerHTML = getStatusHtml(s);

            // Enable/disable animate button
            const card = document.getElementById(`scene-card-${idx}`);
            if (card) {
                const animBtn = card.querySelector('.scene-animation-controls button');
                if (animBtn) animBtn.disabled = !s.imageUrl;
            }
        }

        function updateAnimateAllBtn() {
            const markedCount = visualsScenes.filter(s => s.markedForAnimation).length;
            const btn = document.getElementById('animateAllBtn');
            if (markedCount > 0) {
                btn.style.display = 'inline-block';
                btn.textContent = `Animate ${markedCount} Marked Scene${markedCount > 1 ? 's' : ''}`;
            } else {
                btn.style.display = 'none';
            }
        }

        function updateImageProgress() {
            const total = visualsScenes.length;
            const done = visualsScenes.filter(s => s.imageStatus === 'complete').length;
            const generating = visualsScenes.filter(s => s.imageStatus === 'generating').length;
            const el = document.getElementById('visualsImageProgress');
            if (generating > 0 || done > 0) {
                el.style.display = 'inline';
                el.textContent = generating > 0
                    ? `Images: ${done}/${total} done (${generating} generating...)`
                    : `Images: ${done}/${total} done`;
            } else {
                el.style.display = 'none';
            }
        }

        function updateVideoProgress() {
            const total = visualsScenes.length;
            const done = visualsScenes.filter(s => s.videoStatus === 'complete').length;
            const active = visualsScenes.filter(s => s.videoStatus === 'generating' || s.videoStatus === 'polling').length;
            const el = document.getElementById('visualsVideoProgress');
            if (active > 0 || done > 0) {
                el.style.display = 'inline';
                el.textContent = active > 0
                    ? `Videos: ${done}/${total} done (${active} animating...)`
                    : `Videos: ${done}/${total} done`;
            } else {
                el.style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ Image Generation ‚îÄ‚îÄ
        function buildImageRequestBody(idx) {
            const s = visualsScenes[idx];
            return {
                scene_id: s.sceneId,
                prompt: s.imagePrompt,
                model: s.imageModel || visualsConfig.imageModel,
                aspect_ratio: visualsConfig.aspectRatio,
                resolution: visualsConfig.resolution,
                style_images: visualsConfig.styleImages.map(img => img.data),
                character_images: getAllCharacterImages(),
                additional_context: visualsConfig.additionalContext,
            };
        }

        async function generateSceneImage(idx) {
            const s = visualsScenes[idx];
            if (!s) { console.error(`Scene ${idx} not found. ${visualsScenes.length} scenes loaded.`); return; }
            s.imageStatus = 'generating';
            s.imageError = null;
            updateSceneCard(idx);
            updateImageProgress();

            try {
                const body = buildImageRequestBody(idx);
                const res = await authFetch('/api/visuals/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();

                if (!res.ok || data.error) throw new Error(data.error || 'Image generation failed');

                s.imageStatus = 'complete';
                s.imageUrl = data.image_url;
            } catch (e) {
                s.imageStatus = 'error';
                s.imageError = e.message;
            }

            updateSceneCard(idx);
            updateImageProgress();
        }

        async function regenerateSceneImage(idx) {
            // Read latest prompt from textarea
            const textarea = document.getElementById(`scene-img-prompt-${idx}`);
            if (textarea) visualsScenes[idx].imagePrompt = textarea.value;
            await generateSceneImage(idx);
        }

        async function generateAllImages() {
            updateVisualsConfig();

            if (visualsGenerationPhase === 'idle') {
                // Phase 1: Generate Scene 1 for review
                visualsGenerationPhase = 'preview';
                const btn = document.getElementById('generateAllImagesBtn');
                btn.disabled = true;
                btn.textContent = 'Generating Scene 1...';

                await generateSceneImage(0);

                btn.disabled = false;
                if (visualsScenes[0].imageStatus === 'complete') {
                    btn.textContent = `Generate Remaining ${visualsScenes.length - 1} Images`;
                    visualsGenerationPhase = 'preview';
                } else {
                    btn.textContent = 'Retry Scene 1';
                    visualsGenerationPhase = 'idle';
                }
                return;
            }

            if (visualsGenerationPhase === 'preview') {
                // Phase 2: Batch all remaining scenes
                visualsGenerationPhase = 'batch';
                const btn = document.getElementById('generateAllImagesBtn');
                btn.disabled = true;
                btn.textContent = 'Generating all images...';

                // Read all prompts from textareas
                visualsScenes.forEach((s, i) => {
                    const ta = document.getElementById(`scene-img-prompt-${i}`);
                    if (ta) s.imagePrompt = ta.value;
                });

                const remaining = visualsScenes
                    .map((s, i) => ({ scene: s, idx: i }))
                    .filter(item => item.scene.imageStatus !== 'complete');

                if (remaining.length === 0) {
                    btn.textContent = 'All Images Generated';
                    return;
                }

                // Build batch request
                const scenes = remaining.map(item => ({
                    scene_id: item.scene.sceneId,
                    prompt: item.scene.imagePrompt,
                    model: item.scene.imageModel || null,
                }));

                // Mark all as generating
                remaining.forEach(item => {
                    item.scene.imageStatus = 'generating';
                    updateSceneCard(item.idx);
                });
                updateImageProgress();

                try {
                    const res = await authFetch('/api/visuals/generate-batch-images', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenes,
                            global_config: {
                                model: visualsConfig.imageModel,
                                aspect_ratio: visualsConfig.aspectRatio,
                                resolution: visualsConfig.resolution,
                                style_images: visualsConfig.styleImages.map(img => img.data),
                                character_images: getAllCharacterImages(),
                                additional_context: visualsConfig.additionalContext,
                            },
                        }),
                    });

                    const data = await res.json();

                    if (data.results) {
                        for (const result of data.results) {
                            const sceneIdx = visualsScenes.findIndex(s => s.sceneId === String(result.scene_id));
                            if (sceneIdx === -1) continue;
                            const s = visualsScenes[sceneIdx];

                            if (result.success && result.image_url) {
                                s.imageStatus = 'complete';
                                s.imageUrl = result.image_url;
                            } else {
                                s.imageStatus = 'error';
                                s.imageError = result.error || 'Unknown error';
                            }
                            updateSceneCard(sceneIdx);
                        }
                    }
                } catch (e) {
                    remaining.forEach(item => {
                        if (item.scene.imageStatus === 'generating') {
                            item.scene.imageStatus = 'error';
                            item.scene.imageError = e.message;
                            updateSceneCard(item.idx);
                        }
                    });
                }

                updateImageProgress();
                btn.disabled = false;
                const errors = visualsScenes.filter(s => s.imageStatus === 'error').length;
                btn.textContent = errors > 0
                    ? `Retry ${errors} Failed Image${errors > 1 ? 's' : ''}`
                    : 'All Images Generated';
                visualsGenerationPhase = errors > 0 ? 'preview' : 'batch';
            }
        }

        // ‚îÄ‚îÄ Video Animation ‚îÄ‚îÄ
        async function animateScene(idx) {
            const s = visualsScenes[idx];
            if (!s.imageUrl) { alert('Generate the image first'); return; }

            // Read latest animation prompt from textarea
            const textarea = document.getElementById(`scene-veo-prompt-${idx}`);
            if (textarea) s.veoPrompt = textarea.value;

            s.videoStatus = 'generating';
            s.videoError = null;
            updateSceneCard(idx);
            updateVideoProgress();

            try {
                const res = await authFetch('/api/visuals/start-animation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scene_id: s.sceneId,
                        image_url: s.imageUrl,
                        prompt: s.veoPrompt,
                        model: s.veoModel || visualsConfig.veoModel,
                        aspect_ratio: visualsConfig.aspectRatio,
                        duration: parseInt(s.duration) || 6,
                    }),
                });
                const data = await res.json();

                if (!res.ok || data.error) throw new Error(data.error || 'Failed to start animation');

                s.operationName = data.operation_name;
                s.videoStatus = 'polling';
                updateSceneCard(idx);

                // Start polling
                startPolling(idx);
            } catch (e) {
                s.videoStatus = 'error';
                s.videoError = e.message;
                updateSceneCard(idx);
                updateVideoProgress();
            }
        }

        function startPolling(idx) {
            const s = visualsScenes[idx];
            if (animationPollers[idx]) clearInterval(animationPollers[idx]);

            animationPollers[idx] = setInterval(async () => {
                try {
                    const res = await authFetch('/api/visuals/poll-animation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation_name: s.operationName,
                            scene_id: s.sceneId,
                        }),
                    });
                    const data = await res.json();

                    if (data.status === 'completed') {
                        clearInterval(animationPollers[idx]);
                        delete animationPollers[idx];
                        s.videoStatus = 'complete';
                        s.videoUrl = data.video_url;
                        updateSceneCard(idx);
                        updateVideoProgress();
                    } else if (data.status === 'failed') {
                        clearInterval(animationPollers[idx]);
                        delete animationPollers[idx];
                        s.videoStatus = 'error';
                        s.videoError = data.error || 'Animation failed';
                        updateSceneCard(idx);
                        updateVideoProgress();
                    }
                    // 'in_progress' ‚Äî keep polling
                } catch (e) {
                    clearInterval(animationPollers[idx]);
                    delete animationPollers[idx];
                    s.videoStatus = 'error';
                    s.videoError = e.message;
                    updateSceneCard(idx);
                    updateVideoProgress();
                }
            }, 10000); // Poll every 10 seconds
        }

        async function animateAllScenes() {
            const marked = visualsScenes
                .map((s, i) => ({ scene: s, idx: i }))
                .filter(item => item.scene.markedForAnimation && item.scene.imageUrl && item.scene.videoStatus !== 'complete');

            if (!marked.length) { alert('No eligible scenes to animate. Mark scenes and ensure images are generated.'); return; }

            // Read all animation prompts from textareas
            marked.forEach(item => {
                const ta = document.getElementById(`scene-veo-prompt-${item.idx}`);
                if (ta) item.scene.veoPrompt = ta.value;
            });

            // Mark all as generating
            marked.forEach(item => {
                item.scene.videoStatus = 'generating';
                updateSceneCard(item.idx);
            });
            updateVideoProgress();

            const btn = document.getElementById('animateAllBtn');
            btn.disabled = true;
            btn.textContent = 'Starting animations...';

            try {
                const scenes = marked.map(item => ({
                    scene_id: item.scene.sceneId,
                    image_url: item.scene.imageUrl,
                    prompt: item.scene.veoPrompt,
                    model: item.scene.veoModel || null,
                    duration: parseInt(item.scene.duration) || 6,
                }));

                const res = await authFetch('/api/visuals/start-batch-animation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scenes,
                        global_config: {
                            model: visualsConfig.veoModel,
                            aspect_ratio: visualsConfig.aspectRatio,
                        },
                    }),
                });

                const data = await res.json();

                if (data.operations) {
                    for (const op of data.operations) {
                        const sceneIdx = visualsScenes.findIndex(s => s.sceneId === String(op.scene_id));
                        if (sceneIdx === -1) continue;
                        const s = visualsScenes[sceneIdx];

                        if (op.error) {
                            s.videoStatus = 'error';
                            s.videoError = op.error;
                        } else {
                            s.operationName = op.operation_name;
                            s.videoStatus = 'polling';
                            startPolling(sceneIdx);
                        }
                        updateSceneCard(sceneIdx);
                    }
                }
            } catch (e) {
                marked.forEach(item => {
                    if (item.scene.videoStatus === 'generating') {
                        item.scene.videoStatus = 'error';
                        item.scene.videoError = e.message;
                        updateSceneCard(item.idx);
                    }
                });
            }

            updateVideoProgress();
            btn.disabled = false;
            updateAnimateAllBtn();
        }

        // ‚îÄ‚îÄ Download All Assets ‚îÄ‚îÄ
        async function downloadAllAssets() {
            try {
                const res = await authFetch('/api/visuals/download-all');
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Download failed');
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'visuals_assets.zip';
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                alert('Download failed: ' + e.message);
            }
        }
    </script>
</body>

</html>